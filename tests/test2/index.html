<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ìœ ë ¹ ì„¸ìƒ ì† ë‚˜ëŠ”?</title>

  <!-- âœ… OG(í…ŒìŠ¤íŠ¸2 ë§í¬ìš©) -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="ì—¬ë´‰ì´ ì„±í–¥í…ŒìŠ¤íŠ¸" />
  <meta property="og:title" content="ìœ ë ¹ ì„¸ìƒ ì† ë‚˜ëŠ”?" />
  <meta property="og:description" content="ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸ í•˜ëŸ¬ ê°€ê¸°!" />
  <meta property="og:url" content="https://bongstudiosad.com/tests/test2/" />
  <meta property="og:image" content="https://bongstudiosad.com/img/og_default.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ìœ ë ¹ ì„¸ìƒ ì† ë‚˜ëŠ”?" />
  <meta name="twitter:description" content="ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸ í•˜ëŸ¬ ê°€ê¸°!" />
  <meta name="twitter:image" content="https://bongstudiosad.com/img/og_default.png" />

  <!-- Google Adsense (ìœ ì§€) -->
  <script async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2371351351559028"
    crossorigin="anonymous"></script>

  <!-- âœ… Kakao AdFit Script (í•œ ë²ˆë§Œ ë¡œë“œ) -->
  <script async src="https://t1.daumcdn.net/kas/static/ba.min.js"></script>

  <!-- Kakao SDK -->
  <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js"
          crossorigin="anonymous"></script>
  <script>
    try {
      if (window.Kakao && !Kakao.isInitialized()) {
        Kakao.init("e9794a44d4c69a353097f55a960e6cab");
      }
      console.log("Kakao init:", window.Kakao ? Kakao.isInitialized() : "Kakao SDK not loaded");
    } catch (e) {
      console.warn("Kakao init error (safe):", e);
    }
  </script>

  <link rel="stylesheet" href="/common/common.css?v=2">

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      color: #222;
    }
    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 20px 16px 40px;
      box-sizing: border-box;
    }
    .card {
      background: #fff;
      border-radius: 18px;
      padding: 20px 18px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.05);
      margin-bottom: 18px;
    }

    h1 { font-size: 24px; margin: 0 0 8px; }
    h2 { font-size: 20px; margin: 12px 0 8px; }
    h3 { font-size: 16px; margin: 8px 0 4px; }
    p  { margin: 4px 0; line-height: 1.45; color:#555; }

    .tag {
      display:inline-block;
      background:#efe7ff;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      color:#5a2dce;
      margin-bottom:6px;
      font-weight:800;
    }

    .btn {
      width: 100%;
      padding: 14px 16px;
      border: none;
      border-radius: 999px;
      font-size: 15px;
      font-weight: 600;
      margin-top: 12px;
      cursor: pointer;
      background: #6d4aff;
      color: #fff;
    }
    .btn.secondary {
      background: #eceef3;
      color:#333;
    }
    .btn:active { transform: scale(0.98); }

    .option-btn {
      width: 100%;
      text-align: left;
      border-radius: 14px;
      border: 1px solid #ddd;
      padding: 12px 12px;
      margin-top: 10px;
      background: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    .option-btn:hover {
      background: #f3efff;
      border-color: #6d4aff;
    }

    .progress-bar-bg {
      width:100%;
      height:7px;
      background:#ddd;
      border-radius:999px;
      overflow:hidden;
      margin-top:6px;
    }
    .progress-bar-fill {
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#6d4aff,#b15cff);
      transition:0.3s;
    }

    .spinner {
      width:60px;
      height:60px;
      border-radius:50%;
      border:6px solid #e4dcff;
      border-top-color:#6d4aff;
      animation: spin 1s linear infinite;
      margin:20px auto 0;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      justify-content:center;
      align-items:center;
      z-index:999;
    }
    .popup-card {
      width:85%;
      max-width:380px;
      background:#fff;
      border-radius:18px;
      padding:22px;
      text-align:center;
      margin:0 auto;
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
    }

    .hidden { display:none !important; }

    .ably-banner {
      display:block;
      margin-top:14px;
      padding:16px 14px;
      border-radius:14px;
      background: linear-gradient(135deg, #f3efff, #ffffff);
      border: 1px solid #d9ccff;
      text-decoration:none;
      overflow:hidden;
      position:relative;
    }
    .ably-banner .title {
      font-weight:900;
      color:#6d4aff;
      font-size:16px;
      letter-spacing:-0.2px;
    }
    .ably-banner .desc {
      margin-top:6px;
      color:#666;
      font-size:13px;
      line-height:1.3;
    }
    .ably-badge {
      position:absolute;
      right:12px;
      top:12px;
      background:#6d4aff;
      color:#fff;
      font-size:11px;
      font-weight:800;
      padding:6px 10px;
      border-radius:999px;
    }

    .insta-link {
      display:block;
      margin-top:12px;
      text-align:center;
      padding:12px;
      background:#f3efff;
      color:#6d4aff;
      font-weight:800;
      border-radius:12px;
      text-decoration:none;
    }

    .btn.share-kakao {
      background-color: #FEE500 !important;
      color: #000000 !important;
    }
    .btn.share-x {
      background-color: #000000 !important;
      color: #FFFFFF !important;
    }

    :root{
      --themeColor:#2c1b54;
      --themeTitleColor:#111;
    }

    .result-poster {
      background:#fff;
      border-radius:18px;
      overflow:hidden;
      margin:14px 0 16px;
      box-shadow:0 10px 24px rgba(0,0,0,0.08);
      border:1px solid rgba(0,0,0,0.05);
    }

    .poster-header {
      background: var(--themeColor);
      color:#fff;
      font-weight:900;
      font-size:20px;
      padding:14px 14px;
      text-align:left;
      letter-spacing:-0.2px;
    }

    .poster-image img {
      width:100%;
      height:auto;
      display:block;
      background:#fff;
    }

    .poster-quote { display:none !important; }

    .result-detail-card {
      text-align:left;
      margin-top:12px;
    }

    .result-table {
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }

    .result-table th {
      width:92px;
      text-align:left;
      vertical-align:top;
      padding:10px 8px;
      color:#555;
      font-weight:900;
      white-space:nowrap;
    }

    .result-table td {
      padding:10px 8px;
      line-height:1.5;
      color:#333;
    }

    .result-table tr:not(:last-child) {
      border-bottom:1px solid #eee;
    }

    .result-table .highlight {
      font-weight:900;
      color: var(--themeColor);
    }

    #detail-oneline { font-weight:900; color:#111; }
    #result-title { color:#000000 !important; }

    /* âœ… í‘œì§€ ìë™ì¬ìƒ ì˜ìƒ */
    .cover-video {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 16px;
      display: block;
      object-fit: cover;
      background: #100a24;
    }
  </style>
</head>

<body>

  <div id="nav-mount"></div>

<div class="app">

  <!-- INTRO (í‘œì§€) -->
  <div id="page-intro" class="page hidden">
    <div class="card" style="text-align:center;">
      <span class="tag">ìœ ë ¹ ì„¸ìƒ ì† ë‚˜ëŠ”?</span>
      <h1>ìœ ë ¹ ì„¸ìƒ ì† ë‚˜ëŠ”?</h1>
      <p>ê·€ì‹  ì‚¬íšŒì—ì„œ ë‚˜ëŠ” ì–´ë–¤ íƒ€ì…ì¼ê¹Œ?</p>

      <!-- âœ… ìë™ì¬ìƒ í‘œì§€ ì˜ìƒ -->
      <div style="margin:16px 0;">
        <video
          id="intro-video"
          class="cover-video"
          src="/media/cover_ghost.mp4"
          autoplay
          muted
          loop
          playsinline
          preload="metadata"
        ></video>
      </div>

      <p style="font-size:13px;color:#666;">
        ì´ 6ë¬¸í•­ Â· 1ë¶„ ì»· Â· ê²°ê³¼ëŠ” 9ì¢… ìœ ë ¹ íƒ€ì…!
      </p>

      <button class="btn" onclick="startQuiz()">í…ŒìŠ¤íŠ¸ ì‹œì‘í•˜ê¸°</button>
    </div>

    <!-- âœ… ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸° -->
    <button class="btn secondary" onclick="location.href='/'">â† ë©”ì¸ìœ¼ë¡œ</button>
  </div>

  <!-- QUIZ -->
  <div id="page-quiz" class="page hidden">
    <div class="card">
      <span class="tag">ìœ ë ¹ ì„¸ìƒ ì† ë‚˜ëŠ”?</span>
      <h3 id="progress-text">1 / 6</h3>
      <div class="progress-bar-bg">
        <div id="progress-bar" class="progress-bar-fill"></div>
      </div>

      <h2 id="question-text" style="margin-top:16px;">ì§ˆë¬¸</h2>
      <div id="options-wrap"></div>
    </div>
    <button class="btn secondary" onclick="location.href='/'">â† ë©”ì¸ìœ¼ë¡œ</button>
  </div>

  <!-- LOADING -->
  <div id="page-loading" class="page hidden">
    <div class="card" style="text-align:center;">
      <h2>ğŸ§ª ìœ ë ¹ íƒ€ì… ë¶„ì„ ì¤‘â€¦</h2>
      <p>ê·€ì‹  ì‚¬íšŒ ë°ì´í„°ì— ëŒ€ì¡°ì¤‘ì´ì•¼</p>
      <div class="spinner"></div>
      <p style="font-size:12px;color:#777;margin-top:8px;">ì•½ 3ì´ˆ ì •ë„ ê±¸ë¦½ë‹ˆë‹¤.</p>
    </div>
  </div>

  <!-- RESULT -->
  <div id="page-result" class="page hidden">
    <div class="card" style="text-align:center;">
      <span class="tag">ìœ ë ¹ íƒ€ì… ê²°ê³¼</span>
      <h1 id="result-title">ìœ„ì¹˜ë´‰</h1>

      <!-- âœ… Kakao AdFit 320x50 -->
      <div style="margin:14px 0; display:flex; justify-content:center;">
        <ins class="kakao_ad_area"
             data-ad-unit="DAN-C0JDNFlaMCwZqace"
             data-ad-width="320"
             data-ad-height="50"></ins>

        <script>
          if (window.kakaoAdFit) {
            kakaoAdFit.load();
          }
        </script>
      </div>

      <!-- âœ… ê²°ê³¼ í¬ìŠ¤í„° -->
      <div class="result-poster">
        <div id="poster-header" class="poster-header">ìœ„ì¹˜ë´‰</div>
        <div class="poster-image">
          <img id="poster-image" alt="ê²°ê³¼ í¬ìŠ¤í„° ì´ë¯¸ì§€">
        </div>
        <div id="poster-quote" class="poster-quote"></div>
      </div>

      <!-- âœ… ê²°ê³¼ ì„¤ëª…(í‘œ í˜•ì‹) -->
      <div class="result-detail-card">
        <table class="result-table">
          <tr>
            <th>í•œ ì¤„</th>
            <td id="detail-oneline"></td>
          </tr>
          <tr>
            <th>ìš”ì•½</th>
            <td id="detail-summary"></td>
          </tr>
          <tr>
            <th>ì„±í–¥</th>
            <td id="detail-traits"></td>
          </tr>
          <tr>
            <th>í–‰ë™</th>
            <td id="detail-actions"></td>
          </tr>
          <tr>
            <th>ì˜ë§ëŠ” ìœ ë ¹</th>
            <td id="detail-match" class="highlight"></td>
          </tr>
          <tr>
            <th>ì•ˆë§ëŠ” ìœ ë ¹</th>
            <td id="detail-mismatch"></td>
          </tr>
          <tr>
            <th>ì½”ë©˜íŠ¸</th>
            <td id="detail-comment" class="highlight"></td>
          </tr>
        </table>
      </div>

      <!-- ì—ì´ë¸”ë¦¬ ë°°ë„ˆ -->
      <a class="ably-banner" href="https://applink.a-bly.com/bongstudios" target="_blank">
        <span class="ably-badge">SHOP</span>
        <div class="title">ì—¬ë´‰ì´ êµ¿ì¦ˆìƒµ ë°”ë¡œê°€ê¸°</div>
        <div class="desc">ê²°ê³¼ ë³´ê³  ë§ˆìŒì— ë“œëŠ” êµ¿ì¦ˆ ë°”ë¡œ ë‹´ìœ¼ëŸ¬ ê°€ê¸° â†’</div>
      </a>

      <!-- ì¸ìŠ¤íƒ€ ë§í¬ -->
      <a class="insta-link"
         href="https://www.instagram.com/bong_studios?igsh=d3c5bWl1aXNpc2Zt"
         target="_blank">
        ì—¬ë´‰ì´ ì¸ìŠ¤íƒ€ê·¸ë¨ ë°”ë¡œê°€ê¸°
      </a>

      <div style="display:flex; gap:10px; margin-top:18px;">
        <button class="btn" style="flex:1;" onclick="openSharePopup()">ê³µìœ í•˜ê¸°</button>
        <button class="btn secondary" style="flex:1;" onclick="restartQuiz()">ë‹¤ì‹œí•˜ê¸°</button>
      </div>

      <!-- ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ -->
      <div style="margin-top:14px; display:flex; justify-content:center;">
        <a href="https://link.coupang.com/a/deL5IN" target="_blank" referrerpolicy="unsafe-url">
          <img src="https://ads-partners.coupang.com/banners/950717?subId=&traceId=V0-301-bae0f72e5e59e45f-I950717&w=320&h=100"
               alt=""
               style="max-width:100%; height:auto;">
        </a>
      </div>

    </div>
    <button class="btn secondary" onclick="location.href='/'">â† ë©”ì¸ìœ¼ë¡œ</button>
  </div>

  <div id="footer-mount"></div>

</div>

<!-- ê³µìœ  íŒì—… -->
<div id="share-popup" class="overlay hidden">
  <div class="popup-card" style="max-width:320px;">
    <h2>ê²°ê³¼ ê³µìœ í•˜ê¸°</h2>
    <p style="font-size:14px;color:#666;">ì¹œêµ¬ë“¤ë„ ìœ ë ¹ íƒ€ì… í•œ ë²ˆ ì¬ë³´ì!</p>

    <button class="btn share-kakao" onclick="shareKakao()">ì¹´ì¹´ì˜¤í†¡</button>

    <button class="btn" style="margin-top:10px;background:#bca8ff;color:#1b0b3a;" onclick="shareInstagramStoryOptimal()">
      ì¸ìŠ¤íƒ€ ê³µìœ í•˜ê¸°
    </button>

    <button class="btn share-x" style="margin-top:10px;" onclick="shareXImageOptimal()">
      X ê³µìœ í•˜ê¸°
    </button>

    <button class="btn secondary" style="margin-top:10px;" onclick="copyTestLink()">
      ë§í¬ ë³µì‚¬í•˜ê¸°
    </button>

    <div id="share-status" style="margin-top:12px;font-size:12px;color:#777;min-height:18px;"></div>

    <button class="btn secondary" style="margin-top:12px;" onclick="closeSharePopup()">ë‹«ê¸°</button>
  </div>
</div>

<script>
  /* ========= ê³µí†µ ì„¤ì • ========= */
  const SITE_URL = "https://bongstudiosad.com";
  const TEST_URL = `${SITE_URL}/tests/test2/`; // âœ… í…ŒìŠ¤íŠ¸2 ì£¼ì†Œ

  /* ========= ê²°ê³¼ ì´ë¯¸ì§€(í–‰ë‹˜ ì—…ë¡œë“œ íŒŒì¼ëª… ê¸°ì¤€) ========= */
  const resultMeta = {
    witch:   { title:"ìœ„ì¹˜ë´‰",   desc:"ëª¨ë“  ê±¸ ì•Œê³  ìˆëŠ” ì²™í•˜ëŠ” ì •ë¦¬ ê·€ì‹ ", imageUrl:`${SITE_URL}/img/result_witch.png` },
    mummy:   { title:"ë¯¸ë¼ë´‰",   desc:"ëŠë ¤ë„ ëê¹Œì§€ ë²„í‹°ëŠ” ì§‘ë… ê·€ì‹ ",     imageUrl:`${SITE_URL}/img/result_mummy.png` },
    bat:     { title:"ë°•ì¥ë´‰",   desc:"ë°¤ì—ë§Œ ë‚˜íƒ€ë‚˜ëŠ” ììœ  ê·€ì‹ ",           imageUrl:`${SITE_URL}/img/result_bat.png` },
    ghost:   { title:"ìœ ë ¹ë´‰",   desc:"ì•ˆ ë³´ì´ëŠ”ë° í•µì‹¬ì¸ ì¡´ì¬ ê·€ì‹ ",       imageUrl:`${SITE_URL}/img/result_ghost.png` },
    reaper:  { title:"ì €ìŠ¹ë´‰",   desc:"ê·€ì‹  ì„¸ê³„ì˜ ì§ˆì„œ ë‹´ë‹¹",               imageUrl:`${SITE_URL}/img/result_reaper.png` },
    franken: { title:"í”„ë‘ì¼„ë´‰", desc:"ë¶ˆí‰ì€ ë§ì€ë° ì œì¼ ë§ì´ ì›€ì§ì„",      imageUrl:`${SITE_URL}/img/result_franken.png` },
    pumpkin: { title:"íŒí‚¨ë´‰",   desc:"ë¶„ìœ„ê¸° ì‚´ë¦¬ëŠ” ì†Œë€ ê·€ì‹ ",             imageUrl:`${SITE_URL}/img/result_pumpkin.png` },
    fox:     { title:"êµ¬ë¯¸í˜¸ë´‰", desc:"ë§ë¡œ íŒì„ ë’¤ì§‘ëŠ” êµì„­ ê·€ì‹ ",          imageUrl:`${SITE_URL}/img/result_fox.png` },
    count:   { title:"ë°±ì‘ë´‰",   desc:"í’ˆìœ„ ì§€í‚¤ëŠ” ê³ ê·€í•œ ê·€ì‹ ",             imageUrl:`${SITE_URL}/img/result_count_ghost.png` }
  };

  /* ========= í…Œë§ˆ(ì›í•˜ë©´ ë‚˜ì¤‘ì— ìºë¦­í„°ë³„ë¡œ ë³€ê²½ ê°€ëŠ¥) ========= */
  const ghostTheme = {
    witch:   { bg:"#2c1b54" },
    mummy:   { bg:"#4a2d1f" },
    bat:     { bg:"#15151f" },
    ghost:   { bg:"#3a2a77" },
    reaper:  { bg:"#101018" },
    franken: { bg:"#2a5a43" },
    pumpkin: { bg:"#8c3b00" },
    fox:     { bg:"#6d0f5a" },
    count:   { bg:"#3c0f0f" }
  };

  function applyTheme(key) {
    const t = ghostTheme[key] || ghostTheme.witch;
    document.documentElement.style.setProperty("--themeColor", t.bg);
  }

  /* ========= ê²°ê³¼ ìƒì„¸ + ì˜ë§/ì•ˆë§ ========= */
  const resultDetail = {
    witch: {
      oneline: "â€œíë¦„ì€ ë‚´ê°€ ë‹¤ ë³´ê³  ìˆë‹¤.â€",
      summary: "ì§ì ‘ ë‚˜ì„œì§„ ì•Šì§€ë§Œ, ê·€ì‹  ì‚¬íšŒì˜ íŒì„ ì½ê³  ì •ë¦¬í•˜ëŠ” íƒ€ì….",
      traits: ["ì „ì²´ ìƒí™©ì„ í•œ ë²ˆì— íŒŒì•…", "ë§ì€ ì§§ê³  í•µì‹¬ë§Œ", "í˜¼ë€ì¼ìˆ˜ë¡ ì¹¨ì°©í•¨"],
      actions: ["ë’¤ì—ì„œ ì •ë¦¬ â†’ ë°©í–¥ ì œì‹œ", "í•„ìš”í•  ë•Œë§Œ í•œ ë°©", "ê°ì • ê³¼ì—´ë˜ë©´ ìë™ ì œë™"],
      match: ["ì €ìŠ¹ë´‰", "ìœ ë ¹ë´‰"],
      mismatch: ["íŒí‚¨ë´‰", "ë°•ì¥ë´‰"],
      comment: "ë„ˆ ì—†ìœ¼ë©´ ê·€ì‹  ì‚¬íšŒ íšŒì˜ê°€ ëë‚˜ì§ˆ ì•Šì•„."
    },
    mummy: {
      oneline: "â€œëŠë ¤ë„ ëê¹Œì§€ ë‚¨ì•„ìˆë‹¤.â€",
      summary: "í¬ê¸°ë¼ëŠ” ë‹¨ì–´ê°€ ì—†ëŠ” ì§‘ë…í˜•. ì¡°ìš©íˆ ë²„í‹°ë‹¤ ë§ˆì§€ë§‰ì— ì—­ì „í•œë‹¤.",
      traits: ["ëˆê¸° ìµœìƒ", "í•œ ë²ˆ ì •í•˜ë©´ ì•ˆ ë°”ê¿ˆ", "ë¬´ì‹¬í•œ ë“¯ ê°•í•¨"],
      actions: ["ëê¹Œì§€ í•´ê²° ì‹œë„", "ì‰½ê²Œ í”ë“¤ë¦¬ì§€ ì•ŠìŒ", "ì‚¬ë¼ì§€ì§€ ì•ŠëŠ” ì¡´ì¬ê°"],
      match: ["ë°±ì‘ë´‰", "ìœ ë ¹ë´‰"],
      mismatch: ["ë°•ì¥ë´‰", "íŒí‚¨ë´‰"],
      comment: "ë‹¤ë“¤ ë¬´ì‹œí•˜ë‹¤ê°€ ë§ˆì§€ë§‰ì— ë„ˆ ë³´ê³  ì†Œë¦„ ë‹ëŠ”ë‹¤."
    },
    bat: {
      oneline: "â€œë‚®ì—” ì—†ê³ , ë°¤ì—” í’€ê°€ë™.â€",
      summary: "ê·œì¹™ë³´ë‹¤ ë¦¬ë“¬. ì†Œì†ë³´ë‹¤ ììœ . ì•¼í–‰ì„±ìœ¼ë¡œ íŒì„ í”ë“œëŠ” íƒ€ì….",
      traits: ["ììœ  ìµœìš°ì„ ", "ê¸°ë¶„/ë¦¬ë“¬ íƒ€ëŠ” í¸", "ê°‘ìê¸° ì‚¬ë¼ì¡Œë‹¤ê°€ ë“±ì¥"],
      actions: ["ë°¤ì—ë§Œ í™œë°œ", "ì¬ë°ŒëŠ” ìª½ìœ¼ë¡œ ì´ë™", "ì •í•´ì§„ í‹€ì„ ì‹«ì–´í•¨"],
      match: ["íŒí‚¨ë´‰", "êµ¬ë¯¸í˜¸ë´‰"],
      mismatch: ["ì €ìŠ¹ë´‰", "ë°±ì‘ë´‰"],
      comment: "ë„ˆëŠ” â€˜ê·€ì‹  ì‚¬íšŒì˜ ë³€ì¹™ ì¹´ë“œâ€™ë‹¤."
    },
    ghost: {
      oneline: "â€œì•ˆ ë³´ì´ëŠ”ë°â€¦ ì œì¼ ì¤‘ìš”í•œ ì• .â€",
      summary: "ëˆˆì— ë„ì§„ ì•Šì§€ë§Œ í•­ìƒ í•µì‹¬ì— ìˆë‹¤. ì¡°ìš©íˆ ì¡´ì¬ë¡œ íŒì„ ì¡ëŠ” íƒ€ì….",
      traits: ["ë‚®ì€ ì¡´ì¬ê°, ë†’ì€ ì˜í–¥ë ¥", "ê´€ì°°ë ¥ ì¢‹ìŒ", "í•„ìš”í•  ë•Œë§Œ ë“±ì¥"],
      actions: ["ì‚¬ëŒ ë§ì€ ê³³ì—ì„œ ê´€ì°°", "ê²°ì •ì  ìˆœê°„ì— ë“±ì¥", "ë¶„ìœ„ê¸° íŒŒì•… ë¹ ë¦„"],
      match: ["ìœ„ì¹˜ë´‰", "ë°±ì‘ë´‰"],
      mismatch: ["íŒí‚¨ë´‰", "í”„ë‘ì¼„ë´‰"],
      comment: "ë„ˆëŠ” â€˜ìˆì–´ì•¼ ì‹œìŠ¤í…œì´ ëŒì•„ê°€ëŠ” ìœ ë ¹â€™ì´ë‹¤."
    },
    reaper: {
      oneline: "â€œì„  ë„˜ìœ¼ë©´ ë°”ë¡œ ì»·.â€",
      summary: "ê·€ì‹  ì‚¬íšŒì˜ ì§ˆì„œë¥¼ ë‹´ë‹¹. ê°ì •ì€ ì ì–´ë„ ì‹ ë¢°ëŠ” ë†’ì€ íƒ€ì….",
      traits: ["ê¸°ì¤€ í™•ì‹¤", "ê³µì •í•¨", "ë£°ì„ ì§€í‚¤ê²Œ ë§Œë“¦"],
      actions: ["ì§ˆì„œ ì •ë¦¬", "ì„  ë„˜ëŠ” í–‰ë™ ì°¨ë‹¨", "ë¶„ìŸ ìƒê¸°ë©´ íŒë‹¨ ë‹´ë‹¹"],
      match: ["ìœ„ì¹˜ë´‰", "í”„ë‘ì¼„ë´‰"],
      mismatch: ["ë°•ì¥ë´‰", "íŒí‚¨ë´‰"],
      comment: "ë„ˆ ë•Œë¬¸ì— ê·€ì‹  ì‚¬íšŒê°€ â€˜ì‚¬íšŒâ€™ê°€ ëœë‹¤."
    },
    franken: {
      oneline: "â€œíˆ¬ëœëŒ€ë„ ë‚´ê°€ ë‹¤ í•œë‹¤.â€",
      summary: "ë¶ˆí‰ì€ ë§ì€ë° í•´ê²°ì€ ë” ë§ì´ í•œë‹¤. í˜„ì¥ ìˆ˜ìŠµ ë‹´ë‹¹.",
      traits: ["ì‹¤í–‰ë ¥ ê°•í•¨", "í˜„ì¥í˜•", "ì§œì¦ ë‚´ë„ ì±…ì„ì§"],
      actions: ["ë¬¸ì œ í„°ì§€ë©´ ì¼ë‹¨ ì›€ì§ì„", "ë’¤ëë³´ë‹¤ ê²°ê³¼", "ì¼ ì²˜ë¦¬ ì†ë„ ë¹ ë¦„"],
      match: ["ì €ìŠ¹ë´‰", "íŒí‚¨ë´‰"],
      mismatch: ["ë°±ì‘ë´‰", "ìœ ë ¹ë´‰"],
      comment: "ë„ˆ ì—†ìœ¼ë©´ ê·€ì‹  ì‚¬íšŒëŠ” â€˜ì¼â€™ì´ ë©ˆì¶˜ë‹¤."
    },
    pumpkin: {
      oneline: "â€œì—†ìœ¼ë©´ í—ˆì „, ìˆìœ¼ë©´ ì‹œë„ëŸ¬ì›€.â€",
      summary: "ë¬´ì„­ì§„ ì•Šì€ë° ë¶„ìœ„ê¸°ëŠ” ë„¤ê°€ ë§Œë“ ë‹¤. ì†Œë€+í™œë ¥ ë‹´ë‹¹.",
      traits: ["ì¹œí™”ë ¥ ë†’ìŒ", "ë¶„ìœ„ê¸° ì „í™˜", "ì‹¬ì‹¬í•œ ê±¸ ëª» ì°¸ìŒ"],
      actions: ["ì¥ë‚œ/ì´ë²¤íŠ¸ ìƒì„±", "ì¹¨ì²´ëœ ë¶„ìœ„ê¸° ë„ìš°ê¸°", "ì£¼ëª© ë°›ìœ¼ë©´ ë” í˜ë‚¨"],
      match: ["ë°•ì¥ë´‰", "í”„ë‘ì¼„ë´‰"],
      mismatch: ["ë°±ì‘ë´‰", "ì €ìŠ¹ë´‰"],
      comment: "ë„ˆëŠ” ê·€ì‹  ì‚¬íšŒì˜ â€˜BGMâ€™ì´ë‹¤."
    },
    fox: {
      oneline: "â€œë§ í•œë§ˆë””ë¡œ íŒì„ ë’¤ì§‘ëŠ”ë‹¤.â€",
      summary: "êµì„­/ì¤‘ì¬/ì„¤ë“ì˜ ê·€ì‹ . ì¸ê°„ê³¼ ê·€ì‹  ì‚¬ì´ë„ ì˜¤ê°„ë‹¤.",
      traits: ["ë§ë¹¨/ì„¼ìŠ¤", "ìƒëŒ€ ì‹¬ë¦¬ íŒŒì•…", "í˜‘ìƒ ëŠ¥ë ¥"],
      actions: ["ëŒ€í™”ë¡œ í•´ê²°", "ê°ˆë“± ì¤‘ì¬", "íŒì„ ìœ ë¦¬í•˜ê²Œ ì¬êµ¬ì„±"],
      match: ["ë°•ì¥ë´‰", "ìœ„ì¹˜ë´‰"],
      mismatch: ["ì €ìŠ¹ë´‰", "ë¯¸ë¼ë´‰"],
      comment: "ë„ˆë‘ ëŒ€í™”í•˜ë©´ ê²°ê³¼ê°€ ë°”ë€ë‹¤."
    },
    count: {
      oneline: "â€œì•„ë¬´ ë°ì„œë‚˜ ì•ˆ ë‚˜ì˜¤ëŠ” ê³ ê·€í•¨.â€",
      summary: "ê¸°ì¤€ê³¼ ì·¨í–¥ì´ í™•ì‹¤. í’ˆìœ„ë¥¼ ìœ ì§€í•˜ë©° ê±°ë¦¬ë¥¼ ì¡°ì ˆí•œë‹¤.",
      traits: ["í€„ë¦¬í‹° ì§‘ì°©", "ê¸°ì¤€ ë†’ìŒ", "ì•„ë¬´ë‚˜ ì•ˆ ì—®ì„"],
      actions: ["í•„ìš”í•  ë•Œë§Œ ë“±ì¥", "ì„  ê¸‹ê¸° ê¹”ë”", "ë¶„ìœ„ê¸° ë¬´ê²Œ ì¤‘ì‹¬"],
      match: ["ë¯¸ë¼ë´‰", "ìœ ë ¹ë´‰"],
      mismatch: ["íŒí‚¨ë´‰", "ë°•ì¥ë´‰"],
      comment: "ë„ˆëŠ” ê·€ì‹  ì‚¬íšŒì˜ â€˜ê²©â€™ì´ë‹¤."
    }
  };

  function nl2br(text) { return (text || "").replace(/\n/g, "<br>"); }
  function listToLines(arr) {
    if (!arr || !arr.length) return "â€¢ (í•´ë‹¹ ì—†ìŒ)";
    return arr.map(v => `â€¢ ${v}`).join("<br>");
  }

  /* ========= í˜ì´ì§€ ì „í™˜ ========= */
  const pages = {
    intro: document.getElementById("page-intro"),
    quiz: document.getElementById("page-quiz"),
    loading: document.getElementById("page-loading"),
    result: document.getElementById("page-result"),
  };

  function showPage(name) {
    Object.values(pages).forEach(p => p.classList.add("hidden"));
    pages[name].classList.remove("hidden");
    window.scrollTo({ top: 0 });
  }

  /* ========= í€´ì¦ˆ ë¡œì§(í–‰ë‹˜ ìµœì¢… ì§ˆë¬¸/ìºë¦­í„° ë°°ì¹˜ ìœ ì§€ + ì ìˆ˜ë§Œ ê· ë“±ì¡°ì •) ========= */
  const ghostQuestions = [
    {
      text: "Q1. ì–´ëŠ ë‚  ìœ ë ¹ì´ ëœ ë‚˜! ë‚˜ì˜ ì£¼ í™œë™ ì¥ì†ŒëŠ”?",
      options: [
        { label: "ê°€ì¥ ë†’ì€ ê³³ìœ¼ë¡œê°€ì„œ ë‚´ë ¤ë‹¤ë³¸ë‹¤", scores: { witch:3, count:2, reaper:1 } },
        { label: "ê°€ì¥ ì´ìƒì ì¸ ìë¦¬ë¥¼ ì°¾ì•„ ì¡´ë²„í•œë‹¤", scores: { mummy:3, franken:2 } },
        { label: "ë°¤ì—ë§Œ ë‚˜íƒ€ë‚œë‹¤", scores: { bat:3, fox:2 } },
        { label: "í•œì í•œ ê³³ë³´ë‹¤ëŠ” ë„ì‹¬ì†ì—ì„œ ê´€ì°°í•œë‹¤", scores: { ghost:3, pumpkin:2 } },
      ]
    },
    {
      text: "Q2. ì¸ê°„ê³¼ ë§ˆì£¼ì³¤ë‹¤!! ë‚´ê°€ í•  í–‰ë™ì€?",
      options: [
        { label: "ê°€ë§Œíˆë§Œ ìˆë‹¤ë©´ ì‹ ê²½ ì•ˆì“´ë‹¤.", scores: { reaper:3, franken:2, mummy:2 } },
        { label: "í˜¸ê¸°ì‹¬ì— ì´ë¦¬ì €ë¦¬ ë§ì„ ê±¸ì–´ë³¸ë‹¤", scores: { fox:3, witch:2 } },
        { label: "ê´œíˆ ê² í•œ ë²ˆ ì¤€ë‹¤", scores: { pumpkin:3, ghost:2 } },
        { label: "ê·¸ëƒ¥ ì§€ë‚˜ì¹œë‹¤", scores: { count:3, bat:2 } },
      ]
    },
    {
      text: "Q3. ìœ ë ¹ì„¸ìƒì—ì„œì˜ ë‚˜ì˜ ì—­í™œì€ ?",
      options: [
        { label: "ì „ì²´ ìƒí™© íŒŒì•… í›„ í•´ê²°í•œë‹¤!", scores: { witch:3, count:2 } },
        { label: "ë¨¸ë¦¬ë³´ë‹¨ ëª¸ì´ ë¨¼ì € ì›€ì§ì—¬ì•¼ì§€!", scores: { franken:3, pumpkin:2, bat:2 } },
        { label: "ë„ˆë•Œë¬¸ì— í¥ì´ ë‹¤ ê¹¨ì ¸ë²„ë ¸ìœ¼ë‹ˆ ì±…ì„ì§€ëŠ” ë‹´ë‹¹", scores: { pumpkin:3, fox:2 } },
        { label: "ì–´ì§€ëŸ¬ìš´ê±´ ì‹«ì–´ ì •ë¦¬ì •ëˆì€ ë‚´ê°€ í•œë‹¤!", scores: { reaper:3, ghost:2, mummy:2 } },
      ]
    },
    {
      text: "Q4. ë¬¸ì œê°€ ìƒê²¼ì„ ë•Œì˜ ë‚˜ì˜ ë°˜ì‘ì€?",
      options: [
        { label: "í›„ .. ì¼ë‹¨ ëª°ë¼ë„ ëê¹Œì§€ í•´ê²°í•´ë³¸ë‹¤", scores: { mummy:3, franken:3, reaper:2 } },
        { label: "í•˜ê¸°ì‹«ì€í‹° íŒíŒ ! íˆ¬ëœëŒ€ë©´ì„œë„ í•´ê²°í•œë‹¤", scores: { bat:3, pumpkin:2 } },
        { label: "ë‚˜ëŠ” ë‚´ ìƒê°ê³¼ ë§ë¹¨ë¡œ ìƒí™©ì„ ë°”ê¾¼ë‹¤", scores: { fox:3, witch:2 } },
        { label: "ë‚¨ë“¤ì´ ì•Œì•„ì„œ í•˜ê² ì§€? êµ³ì´ ê°œì…í•˜ì§€ ì•ŠëŠ”ë‹¤", scores: { count:3, ghost:2 } },
      ]
    },
    {
      text: "Q5. ë‹¤ë¥¸ ê·€ì‹ ë“¤ê³¼ì˜ ê±°ë¦¬ê°ì€?",
      options: [
        { label: "ììœ ë¡­ê²Œ ì™”ë‹¤ ê°”ë‹¤ í•œë‹¤", scores: { bat:3, franken:2, witch:2 } },
        { label: "í•„ìš”í•  ë•Œë§Œ ë‚˜íƒ€ë‚œë‹¤", scores: { count:3, fox:2, bat:2 } },
        { label: "ëŠ˜ ì–´ë”˜ê°€ì— ì¡´ì¬í•œë‹¤", scores: { ghost:3, reaper:3 } },
        { label: "ì—†ìœ¼ë©´ í—ˆì „í•œ ì¡´ì¬ë‹¤", scores: { pumpkin:3, mummy:2 } },
      ]
    },
    {
      text: "Q6. ì‚¬ëŒë“¤ì´ ìœ ë ¹ì¸ ë‚˜ë¥¼ ë³´ê³  í•˜ëŠ” ë§ì€?",
      options: [
        { label: "ë„ˆë¬´ ê¸°ì¤€ì´ ì™„ì „ í™•ì‹¤í•´ì„œ ê°€ë” ë¬´ì„œì›Œ!", scores: { reaper:4, witch:3 } },
        { label: "ìœ ë ¹ì´ ì–´ëœ¨ì¼€ ì´ë ‡ê²Œ ë§¤ë ¥ì´ ë„˜ì¹ ê¹Œì•„?", scores: { fox:4, pumpkin:2 } },
        { label: "ë¶„ìœ„ê¸°ê°€ ê´œíˆ ë§ ê±¸ê¸° ì–´ë ¤ìš´ ìŠ¤íƒ€ì¼ì´ì•¼", scores: { count:4, mummy:3 } },
        { label: "ì–¸ì œë¶€í„° ì¸ì§€ëŠ” ì˜ëª¨ë¥´ê² ëŠ”ë° í•­ìƒ ê³ì— ìˆëŠ”ê±°ê°™ì•„", scores: { ghost:4, franken:3, bat:3 } },
      ]
    }
  ];

  const scoreState = {
    witch:0, mummy:0, bat:0, ghost:0, reaper:0, franken:0, pumpkin:0, fox:0, count:0
  };

  let currentIndex = 0;
  let currentResultKey = "witch";

  const qText = document.getElementById("question-text");
  const optionsWrap = document.getElementById("options-wrap");
  const progressText = document.getElementById("progress-text");
  const progressBar = document.getElementById("progress-bar");

  function resetScores() {
    Object.keys(scoreState).forEach(k => scoreState[k] = 0);
  }

  function startQuiz() {
    // í‘œì§€ ì˜ìƒ ì¬ìƒ ì¤‘ì´ë©´ ë©ˆì¶°ë„ ë˜ê³  ê·¸ëƒ¥ ë‘¬ë„ ë¨ (ëª¨ë°”ì¼ ìë™ì¬ìƒì´ë¼ ë¬´í•´)
    const v = document.getElementById("intro-video");
    try { if (v) v.pause(); } catch(e){}

    currentIndex = 0;
    currentResultKey = "witch";
    resetScores();
    resetShareCache();
    renderQuestion();
    showPage("quiz");
  }

  function renderQuestion() {
    const q = ghostQuestions[currentIndex];
    qText.textContent = q.text;
    progressText.textContent = `${currentIndex + 1} / ${ghostQuestions.length}`;
    progressBar.style.width = `${((currentIndex + 1) / ghostQuestions.length) * 100}%`;

    optionsWrap.innerHTML = "";

    [...q.options]
      .sort(() => Math.random() - 0.5)
      .forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.textContent = opt.label;
        btn.onclick = () => selectOption(opt.scores);
        optionsWrap.appendChild(btn);
      });
  }

  function addScores(scoresObj) {
    for (const [k, v] of Object.entries(scoresObj || {})) {
      if (scoreState[k] == null) continue;
      scoreState[k] += Number(v) || 0;
    }
  }

  function selectOption(scoresObj) {
    addScores(scoresObj);
    if (currentIndex < ghostQuestions.length - 1) {
      currentIndex++;
      renderQuestion();
    } else {
      showPage("loading");
      setTimeout(() => {
        calculateResult();
        showPage("result");
      }, 3000);
    }
  }

  function setResultImage(url) {
    const img = document.getElementById("poster-image");
    if (!img) return;
    img.crossOrigin = "anonymous";
    img.src = url;
  }

  function getCurrentMeta() {
    return resultMeta[currentResultKey] || resultMeta.witch;
  }

  function renderResultDetail() {
    const meta = getCurrentMeta();
    const detail = resultDetail[currentResultKey] || resultDetail.witch;

    applyTheme(currentResultKey);

    document.getElementById("poster-header").textContent = meta.title;
    document.getElementById("result-title").textContent = meta.title;

    setResultImage(meta.imageUrl);

    document.getElementById("detail-oneline").innerHTML = nl2br(detail.oneline);
    document.getElementById("detail-summary").innerHTML = nl2br(detail.summary);
    document.getElementById("detail-traits").innerHTML = listToLines(detail.traits);
    document.getElementById("detail-actions").innerHTML = listToLines(detail.actions);
    document.getElementById("detail-match").innerHTML = listToLines((detail.match || []).map(v => v));
    document.getElementById("detail-mismatch").innerHTML = listToLines((detail.mismatch || []).map(v => v));
    document.getElementById("detail-comment").innerHTML = nl2br(detail.comment);
  }

  function calculateResult() {
    // ìµœê³ ì  ì°¾ê¸°
    let bestKey = "witch";
    let bestScore = -Infinity;
    for (const [k, v] of Object.entries(scoreState)) {
      if (v > bestScore) { bestScore = v; bestKey = k; }
    }

    // ë™ì  ì²˜ë¦¬: Q6ì—ì„œ ì ìˆ˜ ë°›ì€ ìª½ì„ ìš°ì„ (í™•ì •ìš©)
    const q6 = ghostQuestions[ghostQuestions.length - 1];
    const q6Candidates = new Set();
    q6.options.forEach(o => Object.keys(o.scores || {}).forEach(k => q6Candidates.add(k)));

    // bestScoreì™€ ê°™ì€ í‚¤ë“¤ ëª¨ìœ¼ê¸°
    const tied = Object.entries(scoreState)
      .filter(([k,v]) => v === bestScore)
      .map(([k]) => k);

    if (tied.length > 1) {
      // Q6 í›„ë³´ì— í¬í•¨ëœ ì• ë“¤ë¡œ ìš°ì„  í•„í„°
      const inQ6 = tied.filter(k => q6Candidates.has(k));
      const pool = inQ6.length ? inQ6 : tied;
      // ê·¸ë˜ë„ ì—¬ëŸ¬ê°œë©´ ëœë¤
      bestKey = pool[Math.floor(Math.random() * pool.length)];
    }

    currentResultKey = bestKey;
    renderResultDetail();
    resetShareCache();
  }

  function restartQuiz() {
    closeSharePopup();
    resetShareCache();
    startQuiz();
  }

  /* ========= ê³µìœ  íŒì—… ========= */
  function openSharePopup() {
    document.getElementById("share-popup").classList.remove("hidden");
    setShareStatus("ìŠ¤í† ë¦¬ ì´ë¯¸ì§€ ì¤€ë¹„ ì¤‘â€¦");
    prebuildStoryShareAsset()
      .then(() => setShareStatus("ê³µìœ  ì¤€ë¹„ ì™„ë£Œ!"))
      .catch(() => setShareStatus("ì´ë¯¸ì§€ ì¤€ë¹„ ì‹¤íŒ¨: ê²°ê³¼ ì´ë¯¸ì§€ ê²½ë¡œ/ë„ë©”ì¸ í™•ì¸ í•„ìš”"));
  }
  function closeSharePopup() {
    document.getElementById("share-popup").classList.add("hidden");
    setShareStatus("");
  }

  async function copyTestLink() {
    const link = TEST_URL;
    const ok = await safeClipboardWrite(link);
    if (ok) { setShareStatus("âœ… ë§í¬ê°€ ë³µì‚¬ëì–´!"); return; }

    try {
      const ta = document.createElement("textarea");
      ta.value = link;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "0";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      document.execCommand("copy");
      ta.remove();
      setShareStatus("âœ… ë§í¬ê°€ ë³µì‚¬ëì–´!");
    } catch (e) {
      setShareStatus("ë³µì‚¬ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸ í•„ìš”");
    }
  }

  /* ========= âœ… ì¹´ì¹´ì˜¤ ê³µìœ  (í…ŒìŠ¤íŠ¸2 ë§í¬) ========= */
  function shareKakao() {
    if (!window.Kakao || !Kakao.isInitialized()) {
      alert("ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ì¤€ë¹„ ì¤‘ì´ì•¼. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì¤˜!");
      return;
    }

    const meta = getCurrentMeta();
    const mainUrl = TEST_URL;

    Kakao.Share.sendDefault({
      objectType: "feed",
      content: {
        title: `ìœ ë ¹ ì„¸ìƒ ì† ë‚˜ëŠ”? - ${meta.title}`,
        description: `${meta.desc}

ğŸ‘‰ í…ŒìŠ¤íŠ¸ í•˜ëŸ¬ê°€ê¸°
${mainUrl}`,
        imageUrl: meta.imageUrl,
        link: {
          mobileWebUrl: mainUrl,
          webUrl: mainUrl
        }
      },
      buttons: [
        {
          title: "ğŸ” ë‚˜ë„ í…ŒìŠ¤íŠ¸í•˜ê¸°",
          link: {
            mobileWebUrl: mainUrl,
            webUrl: mainUrl
          }
        },
        {
          title: "ğŸ“‹ ë‚´ ê²°ê³¼ ë‹¤ì‹œë³´ê¸°",
          link: {
            mobileWebUrl: `${mainUrl}?r=${currentResultKey}`,
            webUrl: `${mainUrl}?r=${currentResultKey}`
          }
        }
      ]
    });
  }

  /* ========= ì¸ìŠ¤íƒ€/ìŠ¤í† ë¦¬ ì´ë¯¸ì§€ ìƒì„± (ìœ ì§€) ========= */
  function loadImage(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = url;
    });
  }

  function canvasToBlob(canvas, type = "image/png", quality) {
    return new Promise((resolve) => canvas.toBlob(resolve, type, quality));
  }

  function wrapText(ctx, text, centerX, startY, maxWidth, lineHeight) {
    const words = (text || "").split(" ");
    let line = "";
    let y = startY;

    ctx.textAlign = "center";
    for (let i = 0; i < words.length; i++) {
      const testLine = line + words[i] + " ";
      const metrics = ctx.measureText(testLine);
      if (metrics.width > maxWidth && i > 0) {
        ctx.fillText(line.trim(), centerX, y);
        line = words[i] + " ";
        y += lineHeight;
      } else {
        line = testLine;
      }
    }
    if (line.trim()) ctx.fillText(line.trim(), centerX, y);
  }

  function roundRect(ctx, x, y, width, height, radius) {
    const r = Math.min(radius, width / 2, height / 2);
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + width, y, x + width, y + height, r);
    ctx.arcTo(x + width, y + height, x, y + height, r);
    ctx.arcTo(x, y + height, x, y, r);
    ctx.arcTo(x, y, x + width, y, r);
    ctx.closePath();
  }

  async function buildStoryImageBlob() {
    const meta = getCurrentMeta();

    const W = 1080;
    const H = 1920;
    const canvas = document.createElement("canvas");
    canvas.width = W;
    canvas.height = H;

    const ctx = canvas.getContext("2d");

    const grad = ctx.createLinearGradient(0, 0, W, H);
    grad.addColorStop(0, "#f3efff");
    grad.addColorStop(1, "#ffffff");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, W, H);

    ctx.fillStyle = "#6d4aff";
    ctx.font = "bold 56px system-ui, -apple-system, Segoe UI, sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("ìœ ë ¹ ì„¸ìƒ ì† ë‚˜ëŠ”?", W / 2, 160);

    ctx.fillStyle = "#222";
    ctx.font = "bold 72px system-ui, -apple-system, Segoe UI, sans-serif";
    ctx.fillText(meta.title, W / 2, 290);

    ctx.fillStyle = "#555";
    ctx.font = "36px system-ui, -apple-system, Segoe UI, sans-serif";
    wrapText(ctx, meta.desc, W / 2, 360, 880, 46);

    try {
      const img = await loadImage(meta.imageUrl);
      const maxW = 860;
      const maxH = 860;
      const scale = Math.min(maxW / img.width, maxH / img.height);
      const dw = img.width * scale;
      const dh = img.height * scale;

      const cardX = (W - 920) / 2;
      const cardY = 480;
      roundRect(ctx, cardX, cardY, 920, 960, 48);
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.fill();
      ctx.strokeStyle = "rgba(109, 74, 255, 0.55)";
      ctx.lineWidth = 6;
      ctx.stroke();

      ctx.drawImage(img, (W - dw) / 2, cardY + 60, dw, dh);
    } catch (e) {
      ctx.fillStyle = "#888";
      ctx.font = "bold 40px system-ui, -apple-system, Segoe UI, sans-serif";
      ctx.fillText("ê²°ê³¼ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨", W / 2, 980);
    }

    ctx.fillStyle = "#6d4aff";
    ctx.font = "bold 40px system-ui, -apple-system, Segoe UI, sans-serif";
    ctx.fillText("ğŸ‘‰ ë‚˜ë„ í…ŒìŠ¤íŠ¸ í•˜ëŸ¬ê°€ê¸°", W / 2, 1780);

    ctx.fillStyle = "#333";
    ctx.font = "36px system-ui, -apple-system, Segoe UI, sans-serif";
    ctx.fillText(TEST_URL, W / 2, 1840);

    return await canvasToBlob(canvas, "image/png");
  }

  const SHARE = {
    storyFileCache: null,
    storyBlobCache: null,
    buildPromise: null,
    busy: false
  };

  function setShareStatus(msg) {
    const el = document.getElementById("share-status");
    if (!el) return;
    el.textContent = msg || "";
  }

  function setShareBusy(on) {
    SHARE.busy = on;
    const popup = document.getElementById("share-popup");
    if (!popup) return;
    popup.querySelectorAll("button").forEach(btn => {
      if (btn.textContent.includes("ë‹«ê¸°")) return;
      btn.disabled = !!on;
      btn.style.opacity = on ? "0.75" : "1";
      btn.style.cursor = on ? "not-allowed" : "pointer";
    });
  }

  async function safeClipboardWrite(text) {
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        return true;
      }
    } catch (e) {}
    return false;
  }

  function resetShareCache() {
    SHARE.storyFileCache = null;
    SHARE.storyBlobCache = null;
    SHARE.buildPromise = null;
    SHARE.busy = false;
    setShareStatus("");
  }

  async function prebuildStoryShareAsset() {
    if (SHARE.storyFileCache && SHARE.storyBlobCache) return { file: SHARE.storyFileCache, blob: SHARE.storyBlobCache };
    if (SHARE.buildPromise) return SHARE.buildPromise;

    SHARE.buildPromise = (async () => {
      const blob = await buildStoryImageBlob();
      const file = new File([blob], "yoboong_ghost_result_story.png", { type: "image/png" });
      SHARE.storyBlobCache = blob;
      SHARE.storyFileCache = file;
      return { file, blob };
    })();

    try { return await SHARE.buildPromise; }
    finally { SHARE.buildPromise = null; }
  }

  function canWebShareFiles(file) {
    try {
      return !!(navigator.share && navigator.canShare && navigator.canShare({ files: [file] }));
    } catch (e) { return false; }
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function shareInstagramStoryOptimal() {
    if (SHARE.busy) return;
    setShareBusy(true);
    setShareStatus("ì¸ìŠ¤íƒ€ ê³µìœ  ì¤€ë¹„ ì¤‘â€¦");

    const meta = getCurrentMeta();
    await safeClipboardWrite(TEST_URL);

    try {
      const { file, blob } = await prebuildStoryShareAsset();

      if (canWebShareFiles(file)) {
        setShareStatus("ê³µìœ  ì‹œíŠ¸ ì—¬ëŠ” ì¤‘â€¦ (ì¸ìŠ¤íƒ€ê·¸ë¨ ì„ íƒ)");
        await navigator.share({
          files: [file],
          title: `ìœ ë ¹ í…ŒìŠ¤íŠ¸ - ${meta.title}`,
          text: `${meta.title} ê²°ê³¼!\n${TEST_URL}`,
          url: TEST_URL
        });
        setShareStatus("ê³µìœ  ì™„ë£Œ!");
        return;
      }

      setShareStatus("ê³µìœ ì‹œíŠ¸ ë¯¸ì§€ì›: ì´ë¯¸ì§€ ì €ì¥ í›„ ì¸ìŠ¤íƒ€ ìŠ¤í† ë¦¬ ì—´ê¸°");
      downloadBlob(blob, "yoboong_ghost_result_story.png");
      setTimeout(() => { window.location.href = "instagram://story-camera"; }, 350);
      setShareStatus("ì´ë¯¸ì§€ ì €ì¥ í›„ ì¸ìŠ¤íƒ€ ìŠ¤í† ë¦¬ì— ì¶”ê°€í•´ì¤˜. (ë§í¬ëŠ” í´ë¦½ë³´ë“œ)");
    } catch (e) {
      console.error(e);
      setShareStatus("ì¸ìŠ¤íƒ€ ê³µìœ  ì‹¤íŒ¨: ê²°ê³¼ ì´ë¯¸ì§€ ê²½ë¡œ/ë„ë©”ì¸(CORS) í™•ì¸ í•„ìš”");
    } finally {
      setShareBusy(false);
    }
  }

  async function shareXImageOptimal() {
    if (SHARE.busy) return;
    setShareBusy(true);
    setShareStatus("X ì´ë¯¸ì§€ ê³µìœ  ì¤€ë¹„ ì¤‘â€¦");

    const meta = getCurrentMeta();

    try {
      const { file } = await prebuildStoryShareAsset();

      if (canWebShareFiles(file)) {
        setShareStatus("ê³µìœ  ì‹œíŠ¸ ì—¬ëŠ” ì¤‘â€¦ (X ì„ íƒ)");
        await navigator.share({
          files: [file],
          title: `ìœ ë ¹ í…ŒìŠ¤íŠ¸ - ${meta.title}`,
          text: `ë‚´ ìœ ë ¹ íƒ€ì…ì€ ${meta.title} ğŸ‘»\në„ˆë„ í•´ë´ ğŸ‘‰\n${TEST_URL}`,
          url: TEST_URL
        });
        setShareStatus("ê³µìœ  ì™„ë£Œ!");
        return;
      }

      const text = encodeURIComponent(`ë‚´ ìœ ë ¹ íƒ€ì…ì€ ${meta.title} ğŸ‘»\në„ˆë„ í•´ë´ ğŸ‘‰`);
      const url = encodeURIComponent(TEST_URL);
      const intent = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
      window.open(intent, "_blank", "noopener,noreferrer");
      setShareStatus("í…ìŠ¤íŠ¸+ë§í¬ë¡œ ê³µìœ ì°½ ì—´ì—ˆì–´!");
    } catch (e) {
      console.error(e);
      setShareStatus("X ê³µìœ  ì‹¤íŒ¨: ë¸Œë¼ìš°ì €/ê¸°ê¸° ê³µìœ  ê¸°ëŠ¥ í™•ì¸ í•„ìš”");
    } finally {
      setShareBusy(false);
    }
  }

  /* ========= âœ… share ë§í¬ë¡œ ë“¤ì–´ì˜¤ë©´ ê²°ê³¼í˜ì´ì§€ë¡œ ë°”ë¡œ ì§„ì… ========= */
  (function bootFromShareLink(){
    const r = new URLSearchParams(location.search).get("r");
    if (r && resultMeta[r]) {
      currentResultKey = r;
      renderResultDetail();
      resetShareCache();
      showPage("result");
      return;
    }

    // âœ… ê¸°ë³¸ ì§„ì…ì€ í‘œì§€
    showPage("intro");
  })();
</script>

<script src="/common/common.js"></script>

</body>
</html>

