<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì—¬ë´‰ì´ ë”ì¿  ë ˆë²¨ í…ŒìŠ¤íŠ¸</title>

  <!-- âœ… OG(í…ŒìŠ¤íŠ¸1 ë§í¬ìš©) -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="ì—¬ë´‰ì´ ì„±í–¥í…ŒìŠ¤íŠ¸" />
  <meta property="og:title" content="ì—¬ë´‰ì´ ë”ì¿  ë ˆë²¨ í…ŒìŠ¤íŠ¸" />
  <meta property="og:description" content="ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸ í•˜ëŸ¬ ê°€ê¸°!" />
  <meta property="og:url" content="https://bongstudiosad.com/tests/test1/" />
  <meta property="og:image" content="https://bongstudiosad.com/img/og_default.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ì—¬ë´‰ì´ ë”ì¿  ë ˆë²¨ í…ŒìŠ¤íŠ¸" />
  <meta name="twitter:description" content="ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸ í•˜ëŸ¬ ê°€ê¸°!" />
  <meta name="twitter:image" content="https://bongstudiosad.com/img/og_default.png" />

  <!-- Kakao SDK -->
  <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js"
          crossorigin="anonymous"></script>
  <script>
    try {
      if (window.Kakao && !Kakao.isInitialized()) {
        Kakao.init("e9794a44d4c69a353097f55a960e6cab");
      }
      console.log("Kakao init:", window.Kakao ? Kakao.isInitialized() : "Kakao SDK not loaded");
    } catch (e) {
      console.warn("Kakao init error (safe):", e);
    }
  </script>

  <link rel="stylesheet" href="/common/common.css?v=2">

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      color: #222;
    }
    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 20px 16px 40px;
      box-sizing: border-box;
    }
    .card {
      background: #fff;
      border-radius: 18px;
      padding: 20px 18px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.05);
      margin-bottom: 18px;
    }

    h1 { font-size: 24px; margin: 0 0 8px; }
    h2 { font-size: 20px; margin: 12px 0 8px; }
    h3 { font-size: 16px; margin: 8px 0 4px; }
    p  { margin: 4px 0; line-height: 1.45; color:#555; }

    .tag {
      display:inline-block;
      background:#ffe1ea;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      color:#b71c1c;
      margin-bottom:6px;
    }

    .btn {
      width: 100%;
      padding: 14px 16px;
      border: none;
      border-radius: 999px;
      font-size: 15px;
      font-weight: 600;
      margin-top: 12px;
      cursor: pointer;
      background: #ff6b81;
      color: #fff;
    }
    .btn.secondary {
      background: #eceef3;
      color:#333;
    }
    .btn:active { transform: scale(0.98); }

    .option-btn {
      width: 100%;
      text-align: left;
      border-radius: 14px;
      border: 1px solid #ddd;
      padding: 12px 12px;
      margin-top: 10px;
      background: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    .option-btn:hover {
      background: #fff5f7;
      border-color: #ff6b81;
    }

    .progress-bar-bg {
      width:100%;
      height:7px;
      background:#ddd;
      border-radius:999px;
      overflow:hidden;
      margin-top:6px;
    }
    .progress-bar-fill {
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#ff6b81,#ffa07a);
      transition:0.3s;
    }

    .spinner {
      width:60px;
      height:60px;
      border-radius:50%;
      border:6px solid #ffd1da;
      border-top-color:#ff6b81;
      animation: spin 1s linear infinite;
      margin:20px auto 0;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:999;
    }
    .popup-card {
      width:85%;
      max-width:380px;
      background:#fff;
      border-radius:18px;
      padding:22px;
      text-align:center;
      margin:0 auto;
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
    }

    .adsense-desc{
  margin-top:12px;
  padding:12px 12px;
  border-radius:14px;
  background:#fafafa;
  border:1px solid #eee;
  text-align:left;
}

.disclosure-box{
  margin-top:12px;
  padding:12px 12px;
  border-radius:14px;
  background:#fff;
  border:1px solid rgba(0,0,0,0.08);
  color:#666;
  font-size:13px;
  line-height:1.5;
}
.disclosure-box b{ color:#222; }
    

    .hidden { display:none !important; }

    .ably-banner {
      display:block;
      margin-top:14px;
      padding:16px 14px;
      border-radius:14px;
      background: linear-gradient(135deg, #ffeef2, #ffffff);
      border: 1px solid #ffd1da;
      text-decoration:none;
      overflow:hidden;
      position:relative;
    }
    .ably-banner .title {
      font-weight:900;
      color:#ff4d6d;
      font-size:16px;
      letter-spacing:-0.2px;
    }
    .ably-banner .desc {
      margin-top:6px;
      color:#666;
      font-size:13px;
      line-height:1.3;
    }
    .ably-badge {
      position:absolute;
      right:12px;
      top:12px;
      background:#ff6b81;
      color:#fff;
      font-size:11px;
      font-weight:800;
      padding:6px 10px;
      border-radius:999px;
    }

    .insta-link {
      display:block;
      margin-top:12px;
      text-align:center;
      padding:12px;
      background:#ffeef2;
      color:#ff6b81;
      font-weight:600;
      border-radius:12px;
      text-decoration:none;
    }

    .btn.share-kakao {
      background-color: #FEE500 !important;
      color: #000000 !important;
    }
    .btn.share-x {
      background-color: #000000 !important;
      color: #FFFFFF !important;
    }

    :root{
      --themeColor:#0f5a2a;
      --themeTitleColor:#111;
    }

    .result-poster {
      background:#fff;
      border-radius:18px;
      overflow:hidden;
      margin:14px 0 16px;
      box-shadow:0 10px 24px rgba(0,0,0,0.08);
      border:1px solid rgba(0,0,0,0.05);
    }

    .poster-header {
      background: var(--themeColor);
      color:#fff;
      font-weight:900;
      font-size:20px;
      padding:14px 14px;
      text-align:left;
      letter-spacing:-0.2px;
    }

    .poster-image img {
      width:100%;
      height:auto;
      display:block;
      background:#fff;
    }

    .poster-quote { display:none !important; }

    .result-detail-card {
      text-align:left;
      margin-top:12px;
    }

    .result-table {
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }

    .result-table th {
      width:92px;
      text-align:left;
      vertical-align:top;
      padding:10px 8px;
      color:#555;
      font-weight:800;
      white-space:nowrap;
    }

    .result-table td {
      padding:10px 8px;
      line-height:1.5;
      color:#333;
    }

    .result-table tr:not(:last-child) {
      border-bottom:1px solid #eee;
    }

    .result-table .highlight {
      font-weight:900;
      color: var(--themeColor);
    }

    #detail-oneline { font-weight:900; color:#111; }
    #result-title { color:#000000 !important; }
  </style>
</head>

<body>

  <div id="nav-mount"></div>

  <div class="app">

    <!-- INTRO (í‘œì§€) -->
    <div id="page-intro" class="page hidden">
      <div class="card" style="text-align:center;">
        <span class="tag">ì—¬ë´‰ì´ ë”ì¿  ë ˆë²¨ í…ŒìŠ¤íŠ¸</span>
        <h1>ì—¬ë´‰ì´ ë”ì¿  ë ˆë²¨ í…ŒìŠ¤íŠ¸</h1>
        <p>ë‚´ê°€ ì™•ì´ ë  ìƒì¸ê°€?</p>

        <div style="
          width:100%;
          aspect-ratio:1 / 1;
          background:#fff4f6;
          border-radius:16px;
          display:flex;
          align-items:center;
          justify-content:center;
          margin:16px 0;
          overflow:hidden;
        ">
          <img
            id="intro-slider"
            src=""
            alt="í…ŒìŠ¤íŠ¸ í‘œì§€ ì´ë¯¸ì§€"
            style="width:100%; height:100%; object-fit:contain; display:block;"
          />
        </div>

        <p style="font-size:13px;color:#666;">
          ì´ 5ë¬¸í•­ Â· 1ë¶„ ì»· Â· ê²°ê³¼ëŠ” ë”ì¿  ë ˆë²¨ë¡œ ë‚˜ì™€ìš”.
        </p>

<!-- âœ… (ì¶”ê°€) ì• ë“œì„¼ìŠ¤ ì‹¬ì‚¬ìš©: í…ŒìŠ¤íŠ¸ ì„¤ëª… -->
<div class="adsense-desc">
  <p><b>ì´ í…ŒìŠ¤íŠ¸ëŠ”</b> â€˜ì—¬ë´‰ì´ ë”ì¿  ë ˆë²¨ í…ŒìŠ¤íŠ¸â€™ë¡œ, 5ê°œì˜ ì§ˆë¬¸ ì„ íƒìœ¼ë¡œ ë‚˜ì˜ ë•ë ¥(?)ì„ ê°€ë³ê²Œ í™•ì¸í•˜ëŠ” ì‹¬ì‹¬í’€ì´ ì½˜í…ì¸ ì•¼.</p>
  <p>ê° ë¬¸í•­ì€ â€œë‚˜ë‘ ì œì¼ ë¹„ìŠ·í•œ ë³´ê¸°â€ë¥¼ ê³ ë¥´ë©´ ë˜ê³ , ì ìˆ˜ í•©ì‚°ìœ¼ë¡œ <b>LV1~LV5</b> ê²°ê³¼ê°€ ë‚˜ì™€. ê²°ê³¼ í˜ì´ì§€ì—ì„œ í•œ ì¤„ ìš”ì•½ + ì„±í–¥ + í–‰ë™ í¬ì¸íŠ¸ê¹Œì§€ ê°™ì´ ë³¼ ìˆ˜ ìˆì–´.</p>
  <p style="margin-top:10px;"><b>ì£¼ì˜!</b> ì´ í…ŒìŠ¤íŠ¸ëŠ” ì¬ë¯¸ë¡œ ë³´ëŠ” ì˜¤ë½ìš©ì´ì•¼. ê²°ê³¼ëŠ” ì ˆëŒ€ í‰ê°€ê°€ ì•„ë‹ˆë¼, â€œìš”ì¦˜ ë‚´ ìƒíƒœâ€ë¥¼ ì›ƒìœ¼ë©´ì„œ ë³´ëŠ” ìš©ë„!</p>
</div>
        
       <div class="disclosure-box">
  <b>ê´‘ê³ /ë§í¬ ì•ˆë‚´</b><br/>
  ì´ í˜ì´ì§€ì—ëŠ” ì„œë¹„ìŠ¤ ìš´ì˜ì„ ìœ„í•œ ê´‘ê³ ê°€ í¬í•¨ë  ìˆ˜ ìˆì–´.
  ì¼ë¶€ ì™¸ë¶€ ë§í¬ëŠ” ì œíœ´(ì¶”ì²œ) ë§í¬ì¼ ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ í†µí•´ ë°œìƒí•œ ìˆ˜ìµì€ ì‚¬ì´íŠ¸ ìš´ì˜ì— ë„ì›€ì´ ë  ìˆ˜ ìˆì–´.
</div>
        
        <button class="btn" onclick="startQuiz()">í…ŒìŠ¤íŠ¸ ì‹œì‘í•˜ê¸°</button>
      </div>

      <!-- âœ… ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸° -->
      <button class="btn secondary" onclick="location.href='/'">â† ë©”ì¸ìœ¼ë¡œ</button>
    </div>

    <!-- QUIZ -->
    <div id="page-quiz" class="page hidden">
      <div class="card">
        <span class="tag">ì—¬ë´‰ì´ ë”ì¿  ë ˆë²¨ í…ŒìŠ¤íŠ¸</span>
        <h3 id="progress-text">1 / 5</h3>
        <div class="progress-bar-bg">
          <div id="progress-bar" class="progress-bar-fill"></div>
        </div>

        <h2 id="question-text" style="margin-top:16px;">ì§ˆë¬¸</h2>
        <div id="options-wrap"></div>
      </div>
      <button class="btn secondary" onclick="location.href='/'">â† ë©”ì¸ìœ¼ë¡œ</button>
    </div>

    <!-- LOADING -->
    <div id="page-loading" class="page hidden">
      <div class="card" style="text-align:center;">
        <h2>ğŸ§® ì„¤ë¬¸ ì™„ë£Œ! ê²°ê³¼ ë§Œë“œëŠ” ì¤‘â€¦</h2>
        <p>ì—¬ë´‰ì´ê°€ ë„ˆì˜ ë ˆë²¨ì„ ì¸¡ì •ì¤‘ì´ì•¼</p>
        <div class="spinner"></div>
        <p style="font-size:12px;color:#777;margin-top:8px;">ì•½ 3ì´ˆ ì •ë„ ê±¸ë¦½ë‹ˆë‹¤.</p>
      </div>
    </div>

    <!-- RESULT -->
    <div id="page-result" class="page hidden">
      <div class="card" style="text-align:center;">
        <span class="tag">ë”ì¿  ë ˆë²¨ ì¸¡ì • ê²°ê³¼</span>
        <h1 id="result-title">LV1. í‚¹ë°˜ì¸</h1>

       
        <!-- âœ… ê²°ê³¼ í¬ìŠ¤í„° -->
        <div class="result-poster">
          <div id="poster-header" class="poster-header">LV1. í‚¹ë°˜ì¸</div>
          <div class="poster-image">
            <img id="poster-image" alt="ê²°ê³¼ í¬ìŠ¤í„° ì´ë¯¸ì§€">
          </div>
          <div id="poster-quote" class="poster-quote">â€œí…ŒìŠ¤íŠ¸ìš© ë¬¸êµ¬â€</div>
        </div>

        <!-- âœ… ê²°ê³¼ ì„¤ëª…(í‘œ í˜•ì‹) -->
        <div class="result-detail-card">
          <table class="result-table">
            <tr>
              <th>í•œ ì¤„</th>
              <td id="detail-oneline"></td>
            </tr>
            <tr>
              <th>ìš”ì•½</th>
              <td id="detail-summary"></td>
            </tr>
            <tr>
              <th>ì„±í–¥</th>
              <td id="detail-traits"></td>
            </tr>
            <tr>
              <th>í–‰ë™</th>
              <td id="detail-actions"></td>
            </tr>
            <tr>
              <th>ì½”ë©˜íŠ¸</th>
              <td id="detail-comment" class="highlight"></td>
            </tr>
          </table>
        </div>

<div class="disclosure-box">
  <b>ê´‘ê³ /ì œíœ´ ì•ˆë‚´</b><br/>
  ì•„ë˜ì—ëŠ” ì‚¬ì´íŠ¸ ìš´ì˜ì„ ìœ„í•œ ê´‘ê³  ë° ì™¸ë¶€ ë§í¬ê°€ í¬í•¨ë  ìˆ˜ ìˆì–´.
  ì¼ë¶€ ë§í¬ëŠ” ì œíœ´ ë§í¬ì¼ ìˆ˜ ìˆìœ¼ë©°, êµ¬ë§¤/ì´ìš© ì‹œ ìš´ì˜ì— ë„ì›€ì´ ë  ìˆ˜ ìˆì–´.
</div>
       
        <!-- ì—ì´ë¸”ë¦¬ ë°°ë„ˆ -->
       <a class="ably-banner" href="https://applink.a-bly.com/bongstudios" target="_blank" rel="noopener noreferrer">
          <span class="ably-badge">SHOP</span>
          <div class="title">ì—¬ë´‰ì´ êµ¿ì¦ˆìƒµ ë°”ë¡œê°€ê¸°</div>
          <div class="desc">ê²°ê³¼ ë³´ê³  ë§ˆìŒì— ë“œëŠ” êµ¿ì¦ˆ ë°”ë¡œ ë‹´ìœ¼ëŸ¬ ê°€ê¸° â†’</div>
        </a>

        <!-- ì¸ìŠ¤íƒ€ ë§í¬ -->
        <a class="insta-link"
           href="https://www.instagram.com/bong_studios?igsh=d3c5bWl1aXNpc2Zt"
           target="_blank"
          rel="noopener noreferrer">
          ì—¬ë´‰ì´ ì¸ìŠ¤íƒ€ê·¸ë¨ ë°”ë¡œê°€ê¸°
        </a>

        <div style="display:flex; gap:10px; margin-top:18px;">
          <button class="btn" style="flex:1;" onclick="openSharePopup()">ê³µìœ í•˜ê¸°</button>
          <button class="btn secondary" style="flex:1;" onclick="restartQuiz()">ë‹¤ì‹œí•˜ê¸°</button>
        </div>

        <!-- âœ… (ì¶”ê°€) ëª¨ë“  ê²°ê³¼ ë³´ê¸° -->

<button class="btn secondary" style="margin-top:10px;" onclick="location.href='/tests/test1/result.html'">
  ê²°ê³¼ íƒ€ì… ì•ˆë‚´ ë³´ê¸°
</button>        

<!-- âœ… (ì¶”ê°€) ì• ë“œì„¼ìŠ¤ ì‹¬ì‚¬ìš©: ê²°ê³¼ í•´ì„ ë¬¸ë‹¨ -->
<div class="adsense-desc" style="text-align:left; margin-top:14px;">
  <p><b>ê²°ê³¼ ì½ëŠ” ë²•</b></p>
  <p>LVëŠ” ìš°ì—´ì´ ì•„ë‹ˆë¼ â€œë•ì§ˆ ìŠ¤íƒ€ì¼â€ì˜ ë°©í–¥ì„ í‘œí˜„í•œ ê±°ì•¼. ì˜¤ëŠ˜ì€ í‚¹ë°˜ì¸ì²˜ëŸ¼ ë‚˜ì™€ë„, ì–´ëŠ ìˆœê°„ í‚¹ ì˜¤ë¸Œ ë”ì¿ ë¡œ ê¸‰ê°€ì†í•  ìˆ˜ë„ ìˆìŒ.</p>
  <p>ì¹œêµ¬ë‘ ê°™ì´ í•´ë³´ê³  ê²°ê³¼ ë¹„êµí•˜ë©´ ë” ì›ƒê²¨! (ì„œë¡œì˜ ë ˆë²¨ì´ë‘ í–‰ë™ í¬ì¸íŠ¸ê°€ ì€ê·¼ ë§ì•„ë–¨ì–´ì§)</p>
</div>

        <!-- ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ -->
        <div style="margin-top:14px; display:flex; justify-content:center;">
          <a href="https://link.coupang.com/a/deL5IN" target="_blank" referrerpolicy="unsafe-url">
            <img src="https://ads-partners.coupang.com/banners/950717?subId=&traceId=V0-301-bae0f72e5e59e45f-I950717&w=320&h=100"
                 alt=""
                 style="max-width:100%; height:auto;">
          </a>
        </div>

      </div>
      <button class="btn secondary" onclick="location.href='/'">â† ë©”ì¸ìœ¼ë¡œ</button>

      <!-- âœ… Kakao AdFit 320x50 (ê²°ê³¼ í˜ì´ì§€ ì§„ì… ì‹œ ë Œë”) -->
<div id="adfit-wrap" style="margin:14px 0; display:flex; justify-content:center; min-height:100px;">
</div>
      
    </div>

    <div id="footer-mount"></div>

  </div>

  <!-- ê³µìœ  íŒì—… -->
  <div id="share-popup" class="overlay hidden">
    <div class="popup-card" style="max-width:320px;">
      <h2>ê²°ê³¼ ê³µìœ í•˜ê¸°</h2>
      <p style="font-size:14px;color:#666;">ì¹œêµ¬ë“¤ë„ ë”ì¿  ê³„ê¸‰ í•œ ë²ˆ ì¬ë³´ì!</p>

      <button class="btn share-kakao" onclick="shareKakao()">ì¹´ì¹´ì˜¤í†¡</button>

      <button class="btn" style="margin-top:10px;background:#ffb6c1;" onclick="shareInstagramStoryOptimal()">
        ì¸ìŠ¤íƒ€ ê³µìœ í•˜ê¸°
      </button>

      <button class="btn share-x" style="margin-top:10px;" onclick="shareXImageOptimal()">
        X ê³µìœ í•˜ê¸°
      </button>

      <button class="btn secondary" style="margin-top:10px;" onclick="copyTestLink()">
        ë§í¬ ë³µì‚¬í•˜ê¸°
      </button>

      <div id="share-status" style="margin-top:12px;font-size:12px;color:#777;min-height:18px;"></div>

      <button class="btn secondary" style="margin-top:12px;" onclick="closeSharePopup()">ë‹«ê¸°</button>
    </div>
  </div>

<script>
  /* ========= ê³µí†µ ì„¤ì • ========= */
  const SITE_URL = "https://bongstudiosad.com";
  const TEST_URL = `${SITE_URL}/tests/test1/`; // âœ… í…ŒìŠ¤íŠ¸1 ì£¼ì†Œ

  /* âœ… 2í˜ì´ì§€ í‘œì§€: intro_1~intro_5 ìë™ ë°˜ë³µ */
  const INTRO_SLIDES = [
    `${SITE_URL}/img/intro_1.png`,
    `${SITE_URL}/img/intro_2.png`,
    `${SITE_URL}/img/intro_3.png`,
    `${SITE_URL}/img/intro_4.png`,
    `${SITE_URL}/img/intro_5.png`,
  ];
  let introSlideIdx = 0;
  let introTimer = null;

  function preloadIntroSlides() {
    INTRO_SLIDES.forEach(src => { const i = new Image(); i.src = src; });
  }

  function setIntroSlide(src) {
    const el = document.getElementById("intro-slider");
    if (!el) return;
    el.src = src;
  }

  function startIntroSlider() {
    const el = document.getElementById("intro-slider");
    if (!el) return;

    preloadIntroSlides();
    if (introTimer) clearInterval(introTimer);

    el.style.opacity = "1";
    el.src = INTRO_SLIDES[introSlideIdx];

    introTimer = setInterval(() => {
      introSlideIdx = (introSlideIdx + 1) % INTRO_SLIDES.length;
      setIntroSlide(INTRO_SLIDES[introSlideIdx]);
    }, 128);
  }

  function stopIntroSlider() {
    if (introTimer) clearInterval(introTimer);
    introTimer = null;
  }

  /* ==============================
     âœ… Kakao AdFit (test2 ë°©ì‹ìœ¼ë¡œ ì•ˆì •í™”)
     - ê²°ê³¼ í˜ì´ì§€ê°€ ë³´ì¼ ë•Œë§ˆë‹¤ insë¥¼ ì¬ì‚½ì…
     - ba.min.jsëŠ” 1íšŒë§Œ ë¡œë“œ
  ============================== */
  const ADFIT_UNIT_TEST1 = "DAN-I2vYAuoM4XLlZTIk"; // âœ… ê¸°ì¡´ test1 ìœ ë‹› ê·¸ëŒ€ë¡œ ì‚¬ìš©

  function ensureAdFitScriptOnce() {
    if (document.getElementById("kakao-adfit-script")) return;
    const s = document.createElement("script");
    s.id = "kakao-adfit-script";
    s.async = true;
    s.src = "https://t1.daumcdn.net/kas/static/ba.min.js";
    document.head.appendChild(s);
  }

 function renderAdFit() {
  const wrap = document.getElementById("adfit-wrap");
  if (!wrap) return;

  // âœ… 1) ë¨¼ì € insë¥¼ DOMì— ì‚½ì…
  wrap.innerHTML = `
    <ins class="kakao_ad_area" style="display:none;"
      data-ad-unit="${ADFIT_UNIT_TEST1}"
      data-ad-width="${ADFIT_W}"
      data-ad-height="${ADFIT_H}"></ins>
  `;

  // âœ… 2) ba.min.jsë¥¼ "ë‹¤ì‹œ" ì‹¤í–‰ì‹œí‚¤ê¸° (SPAì—ì„œ í•„ìˆ˜)
  // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆìœ¼ë©´ ì§€ìš°ê³  ìƒˆë¡œ ì‚½ì…
  const old = document.getElementById("kakao-adfit-script");
  if (old) old.remove();

  const s = document.createElement("script");
  s.id = "kakao-adfit-script";
  s.async = true;
  s.src = "https://t1.daumcdn.net/kas/static/ba.min.js";
  document.body.appendChild(s);
}

  

  /* âœ… ê²°ê³¼ ë ˆë²¨ë³„ í…Œë§ˆ */
  const levelTheme = {
    kingbanin: { bg:"#000000", title:"#000000" },
    pyeongmin: { bg:"#8B5A2B", title:"#8B5A2B" },
    knight:   { bg:"#808080", title:"#808080" },
    count:    { bg:"#0f5a2a", title:"#0f5a2a" },
    kingof:   { bg:"#E53935", title:"#E53935" },
  };

  function applyLevelTheme() {
    const t = levelTheme[currentResultKey] || levelTheme.kingbanin;
    document.documentElement.style.setProperty("--themeColor", t.bg);
    document.documentElement.style.setProperty("--themeTitleColor", t.title);
  }

  const resultMeta = {
    kingbanin: { title:"LV1. í‚¹ë°˜ì¸", desc:"ì•„ì§ì€ í‚¹ë°˜ì¸... í•˜ì§€ë§Œ ì–¸ì œë“  ë”ì¿ ì˜ ê¸¸ë¡œ ì…ë¬¸ ê°€ëŠ¥!", imageUrl:`${SITE_URL}/img/result_kingbanin.png` },
    pyeongmin: { title:"LV2. í‰ë¯¼ ë”ì¿ ", desc:"í‹°ëŠ” ì•ˆ ë‚´ë„ ë•ì‹¬ì´ ì°¨ì˜¤ë¥´ëŠ” í‰ë¯¼ ë”ì¿ !", imageUrl:`${SITE_URL}/img/result_pyeongmin.png` },
    knight:   { title:"LV3. ê¸°ì‚¬ ë”ì¿ ", desc:"ìµœì• ë¥¼ ìœ„í•´ ë­ë“  í•  ìˆ˜ ìˆëŠ” ê¸°ì‚¬ ë”ì¿ !", imageUrl:`${SITE_URL}/img/result_knight.png` },
    count:    { title:"LV4. ê·€ì¡± ë”ì¿ ", desc:"êµ¿ì¦ˆ ì°½ê³ ê°€ ê±°ì˜ ì™•êµ­ê¸‰ì¸ ê·€ì¡± ë”ì¿ !", imageUrl:`${SITE_URL}/img/result_count.png` },
    kingof:   { title:"LV5. í‚¹ ì˜¤ë¸Œ ë”ì¿ ", desc:"ë”ì¿  ì¤‘ì˜ ë”ì¿ , í‚¹ ì˜¤ë¸Œ ë”ì¿ ! ì´ì¯¤ ë˜ë©´ ì¸ìƒì´ ì½˜í…ì¸ ë‹¤.", imageUrl:`${SITE_URL}/img/result_kingof.png` }
  };

  function getCurrentMeta() {
    return resultMeta[currentResultKey] || resultMeta.kingbanin;
  }

  const resultDetail = {
    kingbanin: {
      header: "LV1. í‚¹ë°˜ì¸",
      quote: "ì•„ë¬´ê²ƒë„ ëª¨ë¥´ì§€ë§Œ.. ì•„ë¬´ê²ƒë„ ëª¨ë¥´ì§€ ì•ŠëŠ”ë‹¤!",
      oneline: "â€œì•„ë¬´ê²ƒë„ ëª¨ë¥´ì§€ë§Œ.. ì•„ë¬´ê²ƒë„ ëª¨ë¥´ì§€ ì•ŠëŠ”ë‹¤!â€",
      summary: "ì¼ë°˜ì¸ê³¼ ë”ì¿ ì˜ ê²½ê³„ì„ , ì¼ë°˜ì¸ì´ë¼ ìƒê°í•˜ì§€ë§Œ,\nì•Œê³ ë¦¬ì¦˜ì˜ ì§€ë°°ë¥¼ ë°›ì•„ê°€ë©° ë¬´ì—‡ì´ë“  ë ìˆ˜ìˆëŠ” ë‹¨ê³„",
      traits: ["ë‚˜ ì´ì •ë„ê¹Œì§„ ëª°ë¼ ã…‹ã…‹", "ì–´ ? ì´ê±° ì‡¼ì¸ (ë¦´ìŠ¤)ë¡œ ë´¤ë˜ê±´ë°?", "ì´ ê°€ê²©ì˜ êµ¿ì¦ˆë¥¼ ì‚°ë‹¤ê³ ?!!"],
      actions: ["ì¢‹ì•„í•˜ëŠ”ê±´ ìˆì§€ë§Œ ë”¥í•˜ê²Œ ë“¤ì–´ê°€ì§„ ì•ŠëŠ”í¸", "ë•ì§ˆí•˜ëŠ” ì‚¬ëŒì„ ë³´ë©´ ì‹ ê¸°í•˜ë©´ì„œë„ ì‹ ê¸°í•¨!", "ì•„ëŠ”ê²Œ ìˆìœ¼ë©´ ì‹ ë‚¨ â€œ ì˜¤!!! ë‚˜ ì´ê±° ë³¸ê±°ê°™ì•„!!!â€"],
      comment: "ì–´ëŠìˆœê°„ â€œì•„!? ì´ê±¸ì™œ ì´ì œë´¤ì§€..? í•  ì˜ˆì •â€",
    },
    pyeongmin: {
      header: "LV2. í‰ë¯¼ ë”ì¿ ",
      quote: "ì´ê±° ì•„ëŠ”ê±´ë° í‹°ë‚´ê³ ì‹¶ë‹¤...í‹°ë‚´ë©´ì•ˆëœë‹¤..",
      oneline: "â€œì´ê±° ì•„ëŠ”ê±´ë° í‹°ë‚´ê³ ì‹¶ë‹¤...í‹°ë‚´ë©´ì•ˆëœë‹¤..â€",
      summary: "ì´ë¯¸ ë‘í„°ìš´ íŒ¬ì¸µì´ì§€ë§Œ ìŠ¤ìŠ¤ë¡œ â€œì´ì •ë„ëŠ” ì•„ë‹ˆì§€â€ ìƒê°í•¨",
      traits: ["ì´ë¯¸ ê´€ë ¨ ê³„ì •ë“¤ íŒ”ë¡œìš°ë‹¤ ë˜ì–´ìˆìŒ", "ê³ ë¯¼ì€ í•˜ì§€ë§Œ êµ¿ì¦ˆë¥¼ ì‚¬ì•¼í•¨", "ì•Œê³ ë¦¬ì¦˜ì´ ê¾¸ì¤€í•˜ê²Œ ì½˜í…ì¸ ë¥¼ ë°€ì–´ì¤Œ"],
      actions: ["ë‚´ ë•ì§ˆì„ ê¸°ë¡í•˜ê¸° ì‹œì‘í•¨", "ì§€ì¸ì—ê²Œ ì€ê·¼ìŠ¬ì© ì¶”ì²œì„ í•˜ê¸° ì‹œì‘", "ì…ë• ë¶€ì •ê¸°ì˜ ëì„ ë³´ëŠ”ì¤‘"],
      comment: "â€œë„Œ ì´ë¯¸ ì…ë•í–ˆë‹¤. ì•„ë‹êº¼ê°™ì§€? ë‚˜ë„ ê·¸ë¬ì–´â€",
    },
    knight: {
      header: "LV3. ê¸°ì‚¬ ë”ì¿ ",
      quote: "ì´ ì„¸ê³„ëŠ” ë‚´ê°€ ì§€í‚¨ë‹¤",
      oneline: "â€œì´ ì„¸ê³„ëŠ” ë‚´ê°€ ì§€í‚¨ë‹¤â€",
      summary: "ë•ì§ˆì€ ì·¨ë¯¸ê°€ ì•„ë‹ˆì•¼. ì¼ìƒì´ì•¼",
      traits: ["ê³„íší•˜ì§€ ì•Šì•„ë„ ì¼ì •ì— ë•ì§ˆ í¬í•¨", "ì‹ ì‘, ë–¡ë°¥? ë†“ì¹˜ì§€ ì•Šì„êº¼ì—ìš”", "ì½œë¼ë³´&ì´ë²¤íŠ¸&êµ¿ì¦ˆ ìµœê³ ì•¼ ì§œë¦¿í•´"],
      actions: ["ëª¨ë“  ì •ë³´ë¥¼ ì†Œë¬¸ë‚´ì£¼ê² ì–´!", "â€œì´ê±¸ ì•ˆë´¤ì–´? ì´ê±´ ë´ì•¼ë¼, ì´ê±´ ì§„ì§œ ì¬ë°Œì–´â€ë€ë§ì„ ì…ì— ë‹¬ê³ ì‚¼", "íŒì—…ìŠ¤í† ì–´&í–‰ì‚¬ì— ê°€ë©´ í•­ìƒ ìˆëŠ”í¸"],
      comment: "â€œë‚´ê°€ ìˆì–´ì•¼ ë•ì§ˆ ê¸°ì‚¬ë‹¨ì´ ì‚°ë‹¤!â€",
    },
    count: {
      header: "LV4. ê·€ì¡± ë”ì¿ ",
      quote: "ë•ì§ˆì´ ê³§ ê¶Œë ¥ì´ì•¼",
      oneline: "â€œë•ì§ˆì´ ê³§ ê¶Œë ¥ì´ì•¼â€",
      summary: "í’ˆê²©ìˆëŠ” ë•ì§ˆì˜ ê·€ì¡±",
      traits: ["ì·¨í–¥ì´ í™•ê³ í•˜ë©°, ì´ë¯¸ í•œë¶„ì•¼ì˜ ë§ˆìŠ¤í„°", "êµ¿ì¦ˆì·¨í–¥ë„ í™•ê³ í•¨, ê¸°ì¤€ì— ëª»ë¯¸ì¹˜ëŠ”ê±´ êµ¿ì¦ˆê°€ ì•„ë‹ˆì•¼", "ì™ ë§Œí•œ ì„¸ê³„ê´€ì€ ì´í•´í•˜ê³  ë°”ë¡œ ì„¤ëª…ê°€ëŠ¥"],
      actions: ["ê³ í€„ êµ¿ì¦ˆ, í•œì •íŒ êµ¿ì¦ˆì— ì—´ê´‘", "ë•ì§ˆì—ë„ ë‚˜ë§Œì˜ ì² í•™ì´ìˆìŒ", "ë‚˜ë§Œì˜ ì½˜í…ì¸ ë„ ì°½ì‘í• ìˆ˜ ìˆëŠ” ë‹¨ê³„"],
      comment: "ì—¬ê¸°ë¶€í„°ëŠ” ë•ì§ˆë„ í’ˆìœ„ê°€ ìˆëŠ”ê±°ì•¼",
    },
    kingof: {
      header: "LV5. í‚¹ ì˜¤ë¸Œ ë”ì¿ ",
      quote: "ë•ì§ˆ ê·¸ ìì²´ê°€ ë°”ë¡œ ë‚˜",
      oneline: "â€œë•ì§ˆ ê·¸ ìì²´ê°€ ë°”ë¡œ ë‚˜â€",
      summary: "ìµœê°•ì˜ ê²½ì§€ì— ì˜¤ë¥¸ ë”ì¿ ",
      traits: ["ë§ì´ í•„ìš”ì—†ëŠ” ë•ì§ˆ ì—°ì°¨, 99%ë¥¼ í†µë‹¬í•œ ì™•ì˜ ì˜ì—­", "ëª¨ë“  ë•ì§ˆì€ â€œë‚˜ì˜â€ ê¸°ì¤€ìœ¼ë¡œ ëŒì•„ê°€ëŠ”ì¤‘", "ê±°ì˜ ëª¨ë“  ì„¸ê³„ê´€, ë¹„í•˜ì¸ë“œ í‘ì—­ì‚¬ ê¹Œì§€ ë¨¸ë¦¬ì†ì— ì¡´ì¬", "LV1 - LV4ë¥¼ ì´ë„ëŠ” ì¡´ì¬"],
      actions: ["ì…ë•ì˜ ì •ì„ ê°€ì´ë“œ íˆ¬ì–´", "ìƒˆë¡œìš´ í˜•ì‹ì˜ êµ¿ì¦ˆ, ì»¨í…ì¸ , ë°ˆì„ ìƒì„±í•˜ëŠ” ìœ„ëŒ€í•œ ì¡´ì¬", "ë„ˆ ë•ë¶„ì— ë°©ê¸ˆ ë‹¤ë¥¸ ë”ì¿ ê°€ íƒ„ìƒí–ˆì–´ !"],
      comment: "â€œì¶•í•˜í•´..! ë„ˆëŠ” ì´ë¯¸ ì „ì„¤ì´ì•¼!!â€",
    },
  };

  function nl2br(text) { return (text || "").replace(/\n/g, "<br>"); }
  function listToLines(arr) {
    if (!arr || !arr.length) return "â€¢ (í•´ë‹¹ ì—†ìŒ)";
    return arr.map(v => `â€¢ ${v}`).join("<br>");
  }

  /* ========= í˜ì´ì§€ ì „í™˜ ========= */
  const pages = {
    intro: document.getElementById("page-intro"),
    quiz: document.getElementById("page-quiz"),
    loading: document.getElementById("page-loading"),
    result: document.getElementById("page-result"),
  };

  function showPage(name) {
    Object.values(pages).forEach(p => p.classList.add("hidden"));
    pages[name].classList.remove("hidden");
    window.scrollTo({ top: 0 });

    // âœ… ê²°ê³¼ í˜ì´ì§€ê°€ "ë³´ì´ëŠ” ìˆœê°„" AdFit ë Œë” (í•µì‹¬)
    if (name === "result") {
      setTimeout(() => renderAdFit(), 0);
    }
  }

  /* ========= í€´ì¦ˆ ë¡œì§ ========= */
  const otakuQuestions = [
    { text: "ë¼ë…¸ë²¨ ì–¼ë§ˆë‚˜ë´?", options: [
      { label: "ê·¸ê²Œë­”ë°?", point: 0 },
      { label: "ê°€ë” ì‹¬ì‹¬í•˜ë©´?", point: 5 },
      { label: "ì‹œê°„ë‚ ë•Œ ë¬´ì¡°ê±´ ë´ì•¼ì§€", point: 10 },
    ]},
    { text: "ë„ˆì—ê²Œ ë¼í”„í…”ì€ ë­ì•¼?", options: [
      { label: "ë¼í”„í…”ì´ ë­”ë°?", point: 0 },
      { label: "ì›í”¼ìŠ¤ ?", point: 5 },
      { label: "ë‚´ ì›”ê¸‰ë„ë‘‘ì¤‘ í•˜ë‚˜?", point: 10 },
    ]},
    { text: "ë“±ì¥ì¸ë¬¼ì˜ ì£½ìŒìœ¼ë¡œ ìš´ì ì´ ìˆë‹¤(ì—ì´ìŠ¤ ì œì™¸!)", options: [
      { label: "ìš¸ í•„ìš”ê¹Œì§€ ìˆì„ê¹Œ?", point: 0 },
      { label: "ëˆˆë¬¼ì´ ì°”ë”ë‚œê±°ê°™ì•„", point: 5 },
      { label: "ì œì‘ì‚¬ ë§í•´ë¼ ì—‰ì—‰ì—‰ì—‰", point: 10 },
    ]},
    { text: "ë‚´ê°€ ì•„ëŠ” ë²”ìœ„ì˜ ì• ë‹ˆë©”ì´ì…˜ì€?", options: [
      { label: "ì›ë‚˜ë¸”, ê·€ì¹¼", point: 0 },
      { label: "ë¦¬ì œë¡œ, ì†Œì•„ì˜¨", point: 5 },
      { label: "ì œëª©ì´ 25ê¸€ì ì´ìƒ", point: 10 },
    ]},
    { text: "ì½”ìŠ¤í”„ë ˆ í•´ë´¤ê±°ë‚˜ í•´ë³´ê³ ì‹¶ì€ ì½”ìŠ¤í”„ë ˆ!", options: [
      { label: "ê·¸ëƒ¥ ê°„ë‹¨í•œ í• ë¡œìœˆ ë¶„ì¥ ì •ë„?", point: 0 },
      { label: "ìµœì•  ë³µì¥ í•˜ê³  ë¨¸ë¦¬ ë”°ë¼í•˜ê³  ì´ëŸ°ì •ë„?", point: 5 },
      { label: "ìµœì•  ì˜ìƒ ì£¼ë¬¸ì œì‘, í™”ì¥&ê°€ë°œ ë¬´ì¡°ê±´ ë˜‘ê°™ì´ !!", point: 10 },
    ]},
  ];

  let currentIndex = 0;
  let totalScore = 0;
  let currentResultKey = "kingbanin";

  const qText = document.getElementById("question-text");
  const optionsWrap = document.getElementById("options-wrap");
  const progressText = document.getElementById("progress-text");
  const progressBar = document.getElementById("progress-bar");

  function startQuiz() {
    stopIntroSlider();
    currentIndex = 0;
    totalScore = 0;
    currentResultKey = "kingbanin";
    resetShareCache();
    renderQuestion();
    showPage("quiz");
  }

  function renderQuestion() {
    const q = otakuQuestions[currentIndex];
    qText.textContent = q.text;
    progressText.textContent = `${currentIndex + 1} / ${otakuQuestions.length}`;
    progressBar.style.width = `${((currentIndex + 1) / otakuQuestions.length) * 100}%`;

    optionsWrap.innerHTML = "";

    [...q.options]
      .sort(() => Math.random() - 0.5)
      .forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.textContent = opt.label;
        btn.onclick = () => selectOption(opt.point);
        optionsWrap.appendChild(btn);
      });
  }

  function selectOption(point) {
    totalScore += point;
    if (currentIndex < otakuQuestions.length - 1) {
      currentIndex++;
      renderQuestion();
    } else {
      showPage("loading");
      setTimeout(() => {
        calculateResult();
        showPage("result");
      }, 3000);
    }
  }

  function setResultImage(url) {
    const img = document.getElementById("poster-image");
    if (!img) return;
    img.crossOrigin = "anonymous";
    img.src = url;
  }

  function renderResultDetail() {
    const meta = getCurrentMeta();
    const detail = resultDetail[currentResultKey] || resultDetail.kingbanin;

    applyLevelTheme();

    document.getElementById("poster-header").textContent = detail.header;
    document.getElementById("result-title").textContent = meta.title;

    const pq = document.getElementById("poster-quote");
    if (pq) pq.textContent = "";

    setResultImage(meta.imageUrl);

    document.getElementById("detail-oneline").innerHTML = nl2br(detail.oneline);
    document.getElementById("detail-summary").innerHTML = nl2br(detail.summary);
    document.getElementById("detail-traits").innerHTML = listToLines(detail.traits);
    document.getElementById("detail-actions").innerHTML = listToLines(detail.actions);
    document.getElementById("detail-comment").innerHTML = nl2br(detail.comment);
  }

  function calculateResult() {
    if (totalScore <= 10) currentResultKey = "kingbanin";
    else if (totalScore <= 20) currentResultKey = "pyeongmin";
    else if (totalScore <= 30) currentResultKey = "knight";
    else if (totalScore <= 40) currentResultKey = "count";
    else currentResultKey = "kingof";

    renderResultDetail();
    resetShareCache();
  }

  function restartQuiz() {
    closeSharePopup();
    resetShareCache();
    startQuiz();
  }

  /* ========= ê³µìœ  íŒì—… ========= */
  function openSharePopup() {
    document.getElementById("share-popup").classList.remove("hidden");
    setShareStatus("ìŠ¤í† ë¦¬ ì´ë¯¸ì§€ ì¤€ë¹„ ì¤‘â€¦");
    prebuildStoryShareAsset()
      .then(() => setShareStatus("ê³µìœ  ì¤€ë¹„ ì™„ë£Œ!"))
      .catch(() => setShareStatus("ì´ë¯¸ì§€ ì¤€ë¹„ ì‹¤íŒ¨: ê²°ê³¼ ì´ë¯¸ì§€ ê²½ë¡œ/ë„ë©”ì¸ í™•ì¸ í•„ìš”"));
  }
  function closeSharePopup() {
    document.getElementById("share-popup").classList.add("hidden");
    setShareStatus("");
  }

  async function copyTestLink() {
    const link = TEST_URL;
    const ok = await safeClipboardWrite(link);
    if (ok) { setShareStatus("âœ… ë§í¬ê°€ ë³µì‚¬ëì–´!"); return; }

    try {
      const ta = document.createElement("textarea");
      ta.value = link;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "0";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      document.execCommand("copy");
      ta.remove();
      setShareStatus("âœ… ë§í¬ê°€ ë³µì‚¬ëì–´!");
    } catch (e) {
      setShareStatus("ë³µì‚¬ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸ í•„ìš”");
    }
  }

  /* ========= âœ… ì¹´ì¹´ì˜¤ ê³µìœ  (í…ŒìŠ¤íŠ¸1 ë§í¬) ========= */
  function shareKakao() {
    if (!window.Kakao || !Kakao.isInitialized()) {
      alert("ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ì¤€ë¹„ ì¤‘ì´ì•¼. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì¤˜!");
      return;
    }

    const meta = getCurrentMeta();
    const mainUrl = TEST_URL;

    Kakao.Share.sendDefault({
      objectType: "feed",
      content: {
        title: `ì—¬ë´‰ì´ ë”ì¿  ë ˆë²¨ í…ŒìŠ¤íŠ¸ - ${meta.title}`,
        description: `${meta.desc}

ğŸ‘‰ í…ŒìŠ¤íŠ¸ í•˜ëŸ¬ê°€ê¸°
${mainUrl}`,
        imageUrl: meta.imageUrl,
        link: {
          mobileWebUrl: mainUrl,
          webUrl: mainUrl
        }
      },
      buttons: [
        {
          title: "ğŸ” ë‚˜ë„ í…ŒìŠ¤íŠ¸í•˜ê¸°",
          link: {
            mobileWebUrl: mainUrl,
            webUrl: mainUrl
          }
        },
        {
          title: "ğŸ“‹ ë‚´ ê²°ê³¼ ë‹¤ì‹œë³´ê¸°",
          link: {
            mobileWebUrl: `${mainUrl}?r=${currentResultKey}`,
            webUrl: `${mainUrl}?r=${currentResultKey}`
          }
        }
      ]
    });
  }


  
  /* ========= ì¸ìŠ¤íƒ€/ìŠ¤í† ë¦¬ ì´ë¯¸ì§€ ìƒì„± (ìœ ì§€) ========= */
  function loadImage(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = url;
    });
  }

  function canvasToBlob(canvas, type = "image/png", quality) {
    return new Promise((resolve) => canvas.toBlob(resolve, type, quality));
  }

  function wrapText(ctx, text, centerX, startY, maxWidth, lineHeight) {
    const words = (text || "").split(" ");
    let line = "";
    let y = startY;

    ctx.textAlign = "center";
    for (let i = 0; i < words.length; i++) {
      const testLine = line + words[i] + " ";
      const metrics = ctx.measureText(testLine);
      if (metrics.width > maxWidth && i > 0) {
        ctx.fillText(line.trim(), centerX, y);
        line = words[i] + " ";
        y += lineHeight;
      } else {
        line = testLine;
      }
    }
    if (line.trim()) ctx.fillText(line.trim(), centerX, y);
  }

  function roundRect(ctx, x, y, width, height, radius) {
    const r = Math.min(radius, width / 2, height / 2);
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + width, y, x + width, y + height, r);
    ctx.arcTo(x + width, y + height, x, y + height, r);
    ctx.arcTo(x, y + height, x, y, r);
    ctx.arcTo(x, y, x + width, y, r);
    ctx.closePath();
  }

  async function buildStoryImageBlob() {
    const meta = getCurrentMeta();

    const W = 1080;
    const H = 1920;
    const canvas = document.createElement("canvas");
    canvas.width = W;
    canvas.height = H;

    const ctx = canvas.getContext("2d");

    const grad = ctx.createLinearGradient(0, 0, W, H);
    grad.addColorStop(0, "#ffeef2");
    grad.addColorStop(1, "#ffffff");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, W, H);

    ctx.fillStyle = "#ff4d6d";
    ctx.font = "bold 56px system-ui, -apple-system, Segoe UI, sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("ì—¬ë´‰ì´ ë”ì¿  ë ˆë²¨ í…ŒìŠ¤íŠ¸", W / 2, 160);

    ctx.fillStyle = "#222";
    ctx.font = "bold 72px system-ui, -apple-system, Segoe UI, sans-serif";
    ctx.fillText(meta.title, W / 2, 290);

    ctx.fillStyle = "#555";
    ctx.font = "36px system-ui, -apple-system, Segoe UI, sans-serif";
    wrapText(ctx, meta.desc, W / 2, 360, 880, 46);

    try {
      const img = await loadImage(meta.imageUrl);
      const maxW = 860;
      const maxH = 860;
      const scale = Math.min(maxW / img.width, maxH / img.height);
      const dw = img.width * scale;
      const dh = img.height * scale;

      const cardX = (W - 920) / 2;
      const cardY = 480;
      roundRect(ctx, cardX, cardY, 920, 960, 48);
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.fill();
      ctx.strokeStyle = "rgba(255, 156, 174, 0.9)";
      ctx.lineWidth = 6;
      ctx.stroke();

      ctx.drawImage(img, (W - dw) / 2, cardY + 60, dw, dh);
    } catch (e) {
      ctx.fillStyle = "#888";
      ctx.font = "bold 40px system-ui, -apple-system, Segoe UI, sans-serif";
      ctx.fillText("ê²°ê³¼ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨", W / 2, 980);
    }

    ctx.fillStyle = "#ff6b81";
    ctx.font = "bold 40px system-ui, -apple-system, Segoe UI, sans-serif";
    ctx.fillText("ğŸ‘‰ ë‚˜ë„ í…ŒìŠ¤íŠ¸ í•˜ëŸ¬ê°€ê¸°", W / 2, 1780);

    ctx.fillStyle = "#333";
    ctx.font = "36px system-ui, -apple-system, Segoe UI, sans-serif";
    ctx.fillText(TEST_URL, W / 2, 1840);

    return await canvasToBlob(canvas, "image/png");
  }

  const SHARE = {
    storyFileCache: null,
    storyBlobCache: null,
    buildPromise: null,
    busy: false
  };

  function setShareStatus(msg) {
    const el = document.getElementById("share-status");
    if (!el) return;
    el.textContent = msg || "";
  }

  function setShareBusy(on) {
    SHARE.busy = on;
    const popup = document.getElementById("share-popup");
    if (!popup) return;
    popup.querySelectorAll("button").forEach(btn => {
      if (btn.textContent.includes("ë‹«ê¸°")) return;
      btn.disabled = !!on;
      btn.style.opacity = on ? "0.75" : "1";
      btn.style.cursor = on ? "not-allowed" : "pointer";
    });
  }

  async function safeClipboardWrite(text) {
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        return true;
      }
    } catch (e) {}
    return false;
  }

  function resetShareCache() {
    SHARE.storyFileCache = null;
    SHARE.storyBlobCache = null;
    SHARE.buildPromise = null;
    SHARE.busy = false;
    setShareStatus("");
  }

  async function prebuildStoryShareAsset() {
    if (SHARE.storyFileCache && SHARE.storyBlobCache) return { file: SHARE.storyFileCache, blob: SHARE.storyBlobCache };
    if (SHARE.buildPromise) return SHARE.buildPromise;

    SHARE.buildPromise = (async () => {
      const blob = await buildStoryImageBlob();
      const file = new File([blob], "yoboong_result_story.png", { type: "image/png" });
      SHARE.storyBlobCache = blob;
      SHARE.storyFileCache = file;
      return { file, blob };
    })();

    try { return await SHARE.buildPromise; }
    finally { SHARE.buildPromise = null; }
  }

  function canWebShareFiles(file) {
    try {
      return !!(navigator.share && navigator.canShare && navigator.canShare({ files: [file] }));
    } catch (e) { return false; }
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function shareInstagramStoryOptimal() {
    if (SHARE.busy) return;
    setShareBusy(true);
    setShareStatus("ì¸ìŠ¤íƒ€ ê³µìœ  ì¤€ë¹„ ì¤‘â€¦");

    const meta = getCurrentMeta();
    await safeClipboardWrite(TEST_URL);

    try {
      const { file, blob } = await prebuildStoryShareAsset();

      if (canWebShareFiles(file)) {
        setShareStatus("ê³µìœ  ì‹œíŠ¸ ì—¬ëŠ” ì¤‘â€¦ (ì¸ìŠ¤íƒ€ê·¸ë¨ ì„ íƒ)");
        await navigator.share({
          files: [file],
          title: `ì—¬ë´‰ì´ í…ŒìŠ¤íŠ¸ - ${meta.title}`,
          text: `${meta.title} ê²°ê³¼!\n${TEST_URL}`,
          url: TEST_URL
        });
        setShareStatus("ê³µìœ  ì™„ë£Œ!");
        return;
      }

      setShareStatus("ê³µìœ ì‹œíŠ¸ ë¯¸ì§€ì›: ì´ë¯¸ì§€ ì €ì¥ í›„ ì¸ìŠ¤íƒ€ ìŠ¤í† ë¦¬ ì—´ê¸°");
      downloadBlob(blob, "yoboong_result_story.png");
      setTimeout(() => { window.location.href = "instagram://story-camera"; }, 350);
      setShareStatus("ì´ë¯¸ì§€ ì €ì¥ í›„ ì¸ìŠ¤íƒ€ ìŠ¤í† ë¦¬ì— ì¶”ê°€í•´ì¤˜. (ë§í¬ëŠ” í´ë¦½ë³´ë“œ)");
    } catch (e) {
      console.error(e);
      setShareStatus("ì¸ìŠ¤íƒ€ ê³µìœ  ì‹¤íŒ¨: ê²°ê³¼ ì´ë¯¸ì§€ ê²½ë¡œ/ë„ë©”ì¸(CORS) í™•ì¸ í•„ìš”");
    } finally {
      setShareBusy(false);
    }
  }

  async function shareXImageOptimal() {
    if (SHARE.busy) return;
    setShareBusy(true);
    setShareStatus("X ì´ë¯¸ì§€ ê³µìœ  ì¤€ë¹„ ì¤‘â€¦");

    const meta = getCurrentMeta();

    try {
      const { file } = await prebuildStoryShareAsset();

      if (canWebShareFiles(file)) {
        setShareStatus("ê³µìœ  ì‹œíŠ¸ ì—¬ëŠ” ì¤‘â€¦ (X ì„ íƒ)");
        await navigator.share({
          files: [file],
          title: `ì—¬ë´‰ì´ í…ŒìŠ¤íŠ¸ - ${meta.title}`,
          text: `ë‚´ ê²°ê³¼ëŠ” ${meta.title} ğŸ¤­\në„ˆë„ í•´ë´ ğŸ‘‰\n${TEST_URL}`,
          url: TEST_URL
        });
        setShareStatus("ê³µìœ  ì™„ë£Œ!");
        return;
      }

      const text = encodeURIComponent(`ë‚´ ê²°ê³¼ëŠ” ${meta.title} ğŸ¤­\në„ˆë„ í•´ë´ ğŸ‘‰`);
      const url = encodeURIComponent(TEST_URL);
      const intent = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
      window.open(intent, "_blank", "noopener,noreferrer");
      setShareStatus("í…ìŠ¤íŠ¸+ë§í¬ë¡œ ê³µìœ ì°½ ì—´ì—ˆì–´!");
    } catch (e) {
      console.error(e);
      setShareStatus("X ê³µìœ  ì‹¤íŒ¨: ë¸Œë¼ìš°ì €/ê¸°ê¸° ê³µìœ  ê¸°ëŠ¥ í™•ì¸ í•„ìš”");
    } finally {
      setShareBusy(false);
    }
  }

  /* ========= âœ… share ë§í¬ë¡œ ë“¤ì–´ì˜¤ë©´ ê²°ê³¼í˜ì´ì§€ë¡œ ë°”ë¡œ ì§„ì… ========= */
  (function bootFromShareLink(){
    const r = new URLSearchParams(location.search).get("r");
    if (r && resultMeta[r]) {
      currentResultKey = r;
      renderResultDetail();
      resetShareCache();
      showPage("result");
      return;
    }

    // âœ… ê¸°ë³¸ ì§„ì…ì€ í‘œì§€
    showPage("intro");
    startIntroSlider();
  })();
</script>

<script src="/common/common.js"></script>

</body>
</html>
