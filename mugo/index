<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>여봉이 뽑기</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap");

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 16px;
      font-family: "Segoe UI", system-ui, sans-serif;
      background: #f3f6fb;
      color: #1f2937;
    }
    .hidden { display: none !important; }
    .panel {
      background: #ffffff;
      border: 1px solid #dbe3ee;
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 4px 14px rgba(30, 41, 59, 0.05);
    }
    .setup-screen {
      max-width: 1100px;
      margin: 0 auto;
    }
    .setup-head {
      margin-bottom: 10px;
    }
    .setup-head h1 {
      margin: 0 0 4px 0;
      font-size: 28px;
    }
    .setup-head p {
      margin: 0;
      color: #6b7280;
      font-size: 14px;
    }
    .setup-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .field {
      margin-bottom: 10px;
    }
    .field label {
      display: block;
      margin-bottom: 4px;
      font-size: 13px;
      color: #374151;
      font-weight: 600;
    }
    .field input,
    .field select {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 9px 10px;
      font-size: 14px;
      background: #fff;
    }
    .switch-field {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 28px;
      font-size: 14px;
      font-weight: 600;
    }
    .rank-box {
      margin-top: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
    }
    .rank-row {
      display: grid;
      grid-template-columns: 120px 100px 120px 1fr 82px;
      gap: 8px;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #eef0f2;
      background: #fbfcff;
    }
    .rank-row:last-child { border-bottom: none; }
    .rank-row input,
    .rank-row select {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 7px;
      padding: 8px;
      font-size: 13px;
    }
    .rank-row button {
      border: none;
      border-radius: 7px;
      padding: 8px;
      background: #e5e7eb;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
    }
    .setup-actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .setup-actions button {
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
    }
    #addRankBtn { background: #e8edf5; color: #1f2937; }
    #startGameBtn { background: #2563eb; color: #fff; }
    .setup-note {
      margin-top: 10px;
      font-size: 13px;
      color: #6b7280;
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 16px;
    }
    .page.left-hidden {
      grid-template-columns: 1fr;
    }
    .app-head {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
    }
    .admin-gate-btn {
      grid-column: 1;
      justify-self: start;
      border: 1px solid #cdd7e5;
      background: #f8fbff;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 700;
      color: #334155;
      cursor: pointer;
    }
    .admin-gate-btn:hover {
      background: #edf3fb;
    }
    .app-head h1 {
      margin: 0;
      font-family: "Black Han Sans", "Malgun Gothic", sans-serif;
      font-size: 38px;
      font-weight: 400;
      letter-spacing: 0.3px;
      color: #111827;
      grid-column: 2;
      justify-self: center;
    }
    .title-with-icons {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
    }
    .title-side-icon {
      width: 52px;
      height: 52px;
      object-fit: cover;
      border-radius: 50%;
      background: #e5e7eb;
      flex-shrink: 0;
    }
    .head-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      grid-column: 3;
      justify-self: end;
    }
    .head-actions button {
      border: 1px solid #cdd7e5;
      background: #f8fbff;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .head-actions button:hover {
      background: #edf3fb;
    }
    .draw-entry-btn {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 30;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: #0f172a !important;
      color: #f8fafc;
      border-color: #0b1220 !important;
      box-shadow:
        0 12px 24px rgba(15, 23, 42, 0.35),
        0 0 0 3px rgba(255, 255, 255, 0.72);
      height: 58px;
      padding: 0 18px 0 0 !important;
      font-size: 18px !important;
      font-weight: 800 !important;
      border-radius: 999px !important;
      overflow: hidden;
    }
    .draw-entry-btn:hover {
      background: #020617 !important;
      transform: translateY(-1px);
    }
    .draw-entry-btn img {
      width: 58px;
      height: 100%;
      border-radius: 999px 0 0 999px;
      object-fit: cover;
      background: transparent;
      padding: 0;
      flex-shrink: 0;
    }
    h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
    }
    .remain-list {
      margin: 0;
      padding: 0;
      list-style: none;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      font-size: 13px;
    }
    .remain-list li {
      display: flex;
      justify-content: space-between;
      padding: 9px 10px;
      border-bottom: 1px solid #eef0f2;
      background: #f5f8fd;
    }
    .remain-list li:last-child {
      border-bottom: none;
    }
    .remain-list .label {
      font-weight: 700;
    }
    .remain-list .count {
      font-weight: 700;
      color: #1d4ed8;
    }
    .grid-wrap {
      border: 1px solid #cdd7e5;
      border-radius: 10px;
      background: #f8fbff;
      padding: 14px;
      min-height: 560px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .grid-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .grid-top p {
      margin: 0;
      font-size: 13px;
      color: #475569;
      font-weight: 600;
    }
    .grid-top .status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #cdd7e5;
      background: #ffffff;
      font-size: 13px;
      font-weight: 700;
      color: #0f172a;
    }
    .grid-top .status span {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(15, 1fr);
      gap: 10px;
      flex: 1;
      align-content: start;
    }
    .cell {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 12px;
      border: 2px solid rgba(148, 163, 184, 0.55);
      background: #ffffff;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 8px 12px rgba(15, 23, 42, 0.12);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    .cell:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 16px rgba(15, 23, 42, 0.18);
    }
    .cell.used {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .cell img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .cell .number {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 800;
      color: #0f172a;
      text-shadow: 0 1px 0 rgba(255,255,255,0.6);
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 20;
    }
    .modal.hidden { display: none; }
    .modal-card {
      width: 100%;
      max-width: 640px;
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.28);
      padding: 24px;
      text-align: center;
      user-select: none;
      position: relative;
      overflow: hidden;
    }
    .modal-card > * {
      position: relative;
      z-index: 2;
    }
    .modal-title {
      margin: 0 0 14px 0;
      font-size: 30px;
      font-family: "Black Han Sans", "Malgun Gothic", sans-serif;
      font-weight: 400;
      letter-spacing: 0.2px;
      color: #111827;
    }
    .draw-paper {
      margin: 0 auto 16px auto;
      width: 320px;
      height: 210px;
      border-radius: 14px;
      border: 2px solid #93a8c5;
      position: relative;
      overflow: hidden;
      touch-action: none;
      background: #eef2f7;
      box-shadow:
        0 0 0 3px rgba(255,255,255,0.72),
        0 10px 20px rgba(15, 23, 42, 0.2);
    }
    .draw-reveal-image {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: inherit;
      z-index: 1;
      pointer-events: none;
      background: #ffffff;
    }
    .draw-scratch-canvas {
      position: absolute;
      inset: 0;
      z-index: 2;
      cursor: crosshair;
      border-radius: inherit;
    }
    .modal-info {
      margin: 0 0 16px 0;
      color: #6b7280;
      font-size: 18px;
    }
    .scratch-debug {
      margin: -8px 0 12px 0;
      font-size: 12px;
      color: #9ca3af;
      min-height: 14px;
    }
    .modal-actions {
      display: flex;
      justify-content: center;
    }
    #drawCancelBtn,
    #resultCloseBtn {
      border: none;
      border-radius: 10px;
      padding: 12px 18px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
    }
    #drawCancelBtn { background: #2563eb; color: #fff; }
    #resultCloseBtn { background: #2563eb; color: #fff; }

    .result-modal-card {
      width: 100%;
      max-width: 520px;
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.28);
      padding: 24px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .result-modal-card > * {
      position: relative;
      z-index: 2;
    }
    .modal-bg-image {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center center;
      opacity: 0.28;
      pointer-events: none;
      z-index: 1;
      filter: saturate(0.95);
    }
    .result-modal-title {
      margin: 0 0 14px 0;
      font-size: 34px;
      font-weight: 800;
      color: #111827;
    }
    .result-modal-image-wrap {
      width: 240px;
      height: 240px;
      margin: 0 auto 14px auto;
      border-radius: 12px;
      border: 2px solid #93a8c5;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      box-shadow:
        0 0 0 3px rgba(255,255,255,0.72),
        0 8px 18px rgba(15, 23, 42, 0.16);
    }
    .result-modal-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .result-modal-note {
      margin: 0 0 14px 0;
      color: #6b7280;
      font-size: 16px;
    }
    .result-modal-autoclose {
      margin: -4px 0 12px 0;
      color: #9ca3af;
      font-size: 12px;
    }
    @media (max-width: 920px) {
      .setup-grid { grid-template-columns: 1fr; }
      .rank-row { grid-template-columns: 1fr; }
      .page { grid-template-columns: 1fr; }
      .grid-wrap { height: auto; }
      .app-head {
        grid-template-columns: 1fr;
      }
      .app-head h1 {
        grid-column: 1;
        justify-self: center;
      }
      .admin-gate-btn {
        grid-column: 1;
        justify-self: center;
      }
      .head-actions {
        grid-column: 1;
        justify-self: center;
      }
      .draw-entry-btn {
        right: 14px;
        bottom: 14px;
        justify-content: center;
        min-width: 170px;
        height: 64px;
        padding: 0 18px 0 0 !important;
        font-size: 20px !important;
      }
      .draw-entry-btn img {
        width: 64px;
        height: 100%;
      }
    }
  </style>
</head>
<body>
  <section class="setup-screen panel" id="setupScreen">
    <div class="setup-head">
      <h1>여봉이 뽑기 설정</h1>
      <p>처음 실행 시 설정을 완료하면 뽑기 화면으로 이동합니다.</p>
    </div>

    <div class="setup-grid">
      <div class="field">
        <label for="setupCols">가로 칸 수</label>
        <input id="setupCols" type="number" min="1" max="15" value="15" />
      </div>
      <div class="field">
        <label for="setupRows">세로 칸 수</label>
        <input id="setupRows" type="number" min="1" value="30" />
      </div>
    </div>
    <div class="field">
      <label for="setupAdminPassword">관리자 비밀번호 (기본 0000)</label>
      <input id="setupAdminPassword" type="text" inputmode="numeric" pattern="[0-9]*" value="0000" />
    </div>

    <label class="switch-field">
      <input id="includeMiss" type="checkbox" />
      꽝 포함하기
    </label>

    <div class="rank-box" id="rankRows"></div>
    <div class="setup-actions">
      <button id="addRankBtn" type="button">등수 추가</button>
      <button id="startGameBtn" type="button">설정 저장 후 시작</button>
    </div>
    <p class="setup-note">
      각 등수는 수량(개수) 또는 퍼센트(%)로 설정할 수 있습니다. 꽝 포함 시 남는 수량은 꽝에 자동 추가됩니다.
    </p>
  </section>

  <div class="page hidden" id="gameScreen">
    <div class="app-head">
      <button id="toggleStatusBtn" class="admin-gate-btn" type="button">관리자 외 출입금지</button>
      <h1 class="title-with-icons">
        <img class="title-side-icon" src="/img/title-left.png" alt="왼쪽 캐릭터" />
        <span>멧봉이의 랜덤뽑기</span>
        <img class="title-side-icon" src="/img/title-right.png" alt="오른쪽 캐릭터" />
      </h1>
      <div class="head-actions">
        <button id="openDrawBtn" class="draw-entry-btn" type="button">
          <img id="openDrawBtnImage" src="/img/draw-button.png" alt="캐릭터" />
          랜덤 뽑기
        </button>
      </div>
    </div>

    <div class="panel" id="remainPanel">
      <h2>남은 상품</h2>
      <ul class="remain-list" id="remainList"></ul>
    </div>

    <div class="grid-wrap">
      <div class="grid-top">
        <p>각 칸을 눌러서 뽑아봐! (중복 방지)</p>
        <div class="status" id="statusPill"><span></span><b id="statusText">READY</b></div>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- Draw Modal -->
  <div class="modal hidden" id="drawModal">
    <div class="modal-card">
      <!-- <img class="modal-bg-image" id="drawModalBgImage" src="/img/draw-modal-bg.png" alt="" /> -->
      <h3 class="modal-title">긁어서 확인!</h3>

      <div class="draw-paper">
        <img class="draw-reveal-image" id="drawRevealImage" alt="뽑힌 결과 이미지" />
        <canvas class="draw-scratch-canvas" id="drawScratchCanvas" width="640" height="420"></canvas>
      </div>

      <p class="modal-info" id="drawModalInfo">손가락(마우스)으로 박박 긁어봐!</p>
      <p class="scratch-debug" id="scratchDebugText"></p>

      <div class="modal-actions">
        <button id="drawCancelBtn" type="button">닫기</button>
      </div>
    </div>
  </div>

  <!-- Result Modal -->
  <div class="modal hidden" id="resultModal">
    <div class="result-modal-card">
      <!-- <img class="modal-bg-image" id="resultModalBgImage" src="/img/result-modal-bg.png" alt="" /> -->
      <h3 class="result-modal-title" id="resultModalTitle">결과</h3>
      <div class="result-modal-image-wrap">
        <img class="result-modal-image" id="resultModalImage" alt="결과 이미지" />
      </div>
      <p class="result-modal-note" id="resultModalNote">결과를 확인하세요.</p>
      <p class="result-modal-autoclose" id="resultAutoCloseText">1분 후 자동으로 닫힙니다.</p>

      <div class="modal-actions">
        <button id="resultCloseBtn" type="button">확인</button>
      </div>
    </div>
  </div>

  <script>
    const setupScreen = document.getElementById("setupScreen");
    const gameScreen = document.getElementById("gameScreen");
    const rankRowsEl = document.getElementById("rankRows");
    const setupColsEl = document.getElementById("setupCols");
    const setupRowsEl = document.getElementById("setupRows");
    const includeMissEl = document.getElementById("includeMiss");
    const setupAdminPasswordEl = document.getElementById("setupAdminPassword");
    const startGameBtn = document.getElementById("startGameBtn");
    const addRankBtn = document.getElementById("addRankBtn");

    const remainListEl = document.getElementById("remainList");
    const gridEl = document.getElementById("grid");
    const statusTextEl = document.getElementById("statusText");
    const statusPillEl = document.getElementById("statusPill");

    const toggleStatusBtnEl = document.getElementById("toggleStatusBtn");

    const drawModalEl = document.getElementById("drawModal");
    const drawRevealImageEl = document.getElementById("drawRevealImage");
    const drawScratchCanvasEl = document.getElementById("drawScratchCanvas");
    const drawModalInfoEl = document.getElementById("drawModalInfo");
    const drawCancelBtnEl = document.getElementById("drawCancelBtn");
    const scratchDebugTextEl = document.getElementById("scratchDebugText");

    const resultModalEl = document.getElementById("resultModal");
    const resultModalTitleEl = document.getElementById("resultModalTitle");
    const resultModalImageEl = document.getElementById("resultModalImage");
    const resultModalNoteEl = document.getElementById("resultModalNote");
    const resultAutoCloseTextEl = document.getElementById("resultAutoCloseText");
    const resultCloseBtnEl = document.getElementById("resultCloseBtn");

    const openDrawBtnEl = document.getElementById("openDrawBtn");
    const openDrawBtnImageEl = document.getElementById("openDrawBtnImage");

    const STORAGE_KEY = "yeobong_draw_settings_v4";
    const ADMIN_TOKEN_KEY = "yeobong_draw_admin_token_v1";
    const STATUS_LOCK_KEY = "yeobong_draw_status_locked_v1";
    const USED_CELLS_KEY = "yeobong_draw_used_cells_v1";

    const PAPER_CELL_IMAGE = "/img/paper-button.png";
    const DRAW_MODAL_PAPER_IMAGE = "/img/draw-modal.png";

    const AUTO_CLOSE_MS = 60 * 1000;

    let drawSettings = null;
    let rankRows = [];
    let cols = 15;
    let rows = 30;
    let includeMiss = false;

    let totalCells = 0;
    let usedSet = new Set();

    let pool = [];
    let poolLoaded = false;

    let adminUnlocked = false;
    let statusLocked = false;

    let currentDraw = null;
    let scratchCtx = null;
    let scratchIsDown = false;
    let scratchDrawnPoints = 0;
    let scratchLastPos = null;
    let autoCloseTimer = null;
    let autoCloseStartAt = 0;

    function loadSavedSettings() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === "object" ? parsed : null;
      } catch (e) {
        return null;
      }
    }

    function saveSettings(settings) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
    }

    function getAdminToken() {
      return localStorage.getItem(ADMIN_TOKEN_KEY) || "";
    }

    function setAdminToken(token) {
      localStorage.setItem(ADMIN_TOKEN_KEY, token);
    }

    function getStatusLocked() {
      return localStorage.getItem(STATUS_LOCK_KEY) === "1";
    }

    function setStatusLocked(lock) {
      localStorage.setItem(STATUS_LOCK_KEY, lock ? "1" : "0");
    }

    function loadUsedCells() {
      try {
        const raw = localStorage.getItem(USED_CELLS_KEY);
        if (!raw) return new Set();
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return new Set();
        return new Set(arr.map(String));
      } catch (e) {
        return new Set();
      }
    }

    function saveUsedCells() {
      localStorage.setItem(USED_CELLS_KEY, JSON.stringify([...usedSet]));
    }

    function setStatusPill(text, ok = true) {
      statusTextEl.textContent = text;
      const dot = statusPillEl.querySelector("span");
      dot.style.background = ok ? "#22c55e" : "#ef4444";
    }

    function setAdminUI() {
      toggleStatusBtnEl.textContent = adminUnlocked ? "관리자 모드: ON" : "관리자 외 출입금지";
      toggleStatusBtnEl.style.background = adminUnlocked ? "#fee2e2" : "";
      toggleStatusBtnEl.style.borderColor = adminUnlocked ? "#fecaca" : "";
      toggleStatusBtnEl.style.color = adminUnlocked ? "#7f1d1d" : "";
    }

    function lockStatusUI(lock) {
      statusLocked = lock;
      setStatusLocked(lock);
      if (lock) {
        setStatusPill("LOCKED", false);
      } else {
        setStatusPill("READY", true);
      }
    }

    function createRankRow(data = {}, isFixed = false) {
      const row = document.createElement("div");
      row.className = "rank-row";

      const nameInput = document.createElement("input");
      nameInput.placeholder = "등수명";
      nameInput.value = data.name || "";
      nameInput.disabled = isFixed;

      const modeSelect = document.createElement("select");
      modeSelect.innerHTML = `
        <option value="count">수량</option>
        <option value="percent">퍼센트</option>
      `;
      modeSelect.value = data.mode || "count";
      modeSelect.disabled = isFixed;

      const valueInput = document.createElement("input");
      valueInput.type = "number";
      valueInput.min = "0";
      valueInput.value = data.value != null ? data.value : 0;

      const imgInput = document.createElement("input");
      imgInput.placeholder = "이미지 경로";
      imgInput.value = data.image || "";

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.textContent = "삭제";
      removeBtn.disabled = isFixed;

      removeBtn.addEventListener("click", () => {
        row.remove();
        renderRemainList();
      });

      row.appendChild(nameInput);
      row.appendChild(modeSelect);
      row.appendChild(valueInput);
      row.appendChild(imgInput);
      row.appendChild(removeBtn);

      nameInput.addEventListener("input", renderRemainList);
      modeSelect.addEventListener("change", renderRemainList);
      valueInput.addEventListener("input", renderRemainList);
      imgInput.addEventListener("input", renderRemainList);

      rankRowsEl.appendChild(row);
    }

    function loadDefaultRows() {
      rankRowsEl.innerHTML = "";
      if (includeMissEl.checked) {
        createRankRow({ name: "꽝", mode: "count", value: 0, image: "/img/miss.png" }, true);
      }
      createRankRow({ name: "1등", mode: "count", value: 1, image: "/img/rank1.png" }, false);
      createRankRow({ name: "2등", mode: "count", value: 3, image: "/img/rank2.png" }, false);
      createRankRow({ name: "3등", mode: "percent", value: 5, image: "/img/rank3.png" }, false);
      createRankRow({ name: "4등", mode: "percent", value: 10, image: "/img/rank4.png" }, false);
      createRankRow({ name: "5등", mode: "percent", value: 20, image: "/img/rank5.png" }, false);

      renderRemainList();
    }

    function readRankRows() {
      const rows = [...rankRowsEl.querySelectorAll(".rank-row")];
      return rows.map(row => {
        const [nameInput, modeSelect, valueInput, imgInput] = row.querySelectorAll("input, select");
        return {
          name: nameInput.value.trim(),
          mode: modeSelect.value,
          value: Number(valueInput.value || 0),
          image: imgInput.value.trim()
        };
      }).filter(r => r.name);
    }

    function calcCounts() {
      const currentRows = readRankRows();
      const counts = [];
      let fixedCountSum = 0;
      let percentSum = 0;

      currentRows.forEach(r => {
        if (r.mode === "count") fixedCountSum += r.value;
        if (r.mode === "percent") percentSum += r.value;
      });

      const total = cols * rows;
      let remaining = total - fixedCountSum;
      if (remaining < 0) remaining = 0;

      currentRows.forEach(r => {
        if (r.mode === "count") {
          counts.push({ name: r.name, count: r.value, image: r.image, isMiss: r.name === "꽝" });
        }
      });

      currentRows.forEach(r => {
        if (r.mode === "percent") {
          const c = Math.floor((remaining * r.value) / 100);
          counts.push({ name: r.name, count: c, image: r.image, isMiss: r.name === "꽝" });
        }
      });

      const used = counts.reduce((acc, x) => acc + x.count, 0);
      let remains = total - used;
      if (remains < 0) remains = 0;

      if (includeMiss && remains > 0) {
        const missIdx = counts.findIndex(x => x.isMiss);
        if (missIdx >= 0) counts[missIdx].count += remains;
        else counts.push({ name: "꽝", count: remains, image: "/img/miss.png", isMiss: true });
      }

      return counts;
    }

    function renderRemainList() {
      const counts = calcCounts();
      remainListEl.innerHTML = "";
      counts.forEach(item => {
        const li = document.createElement("li");
        const label = document.createElement("span");
        label.className = "label";
        label.textContent = item.name;

        const count = document.createElement("span");
        count.className = "count";
        count.textContent = item.count;

        li.appendChild(label);
        li.appendChild(count);
        remainListEl.appendChild(li);
      });
    }

    function buildPool() {
      const counts = calcCounts();
      const arr = [];
      counts.forEach(item => {
        for (let i = 0; i < item.count; i++) arr.push(item);
      });
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function showScreen(screen) {
      if (screen === "setup") {
        setupScreen.classList.remove("hidden");
        gameScreen.classList.add("hidden");
        document.body.style.background = "#f3f6fb";
      } else {
        setupScreen.classList.add("hidden");
        gameScreen.classList.remove("hidden");
        document.body.style.background = "#f3f6fb";
      }
    }

    function renderGrid() {
      gridEl.innerHTML = "";
      totalCells = cols * rows;
      usedSet = loadUsedCells();

      gridEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

      for (let idx = 0; idx < totalCells; idx++) {
        const id = String(idx);
        const cell = document.createElement("div");
        cell.className = "cell";
        if (usedSet.has(id)) cell.classList.add("used");

        const img = document.createElement("img");
        img.src = PAPER_CELL_IMAGE;
        img.alt = "뽑기 칸";
        cell.appendChild(img);

        const number = document.createElement("div");
        number.className = "number";
        number.textContent = idx + 1;
        cell.appendChild(number);

        cell.addEventListener("click", () => handleCellClick(idx, cell));
        gridEl.appendChild(cell);
      }
    }

    function ensurePool() {
      if (!poolLoaded) {
        pool = buildPool();
        poolLoaded = true;
      }
    }

    function handleCellClick(idx, cellEl) {
      if (cellEl.classList.contains("used")) return;

      if (statusLocked && !adminUnlocked) {
        setStatusPill("LOCKED", false);
        return;
      }

      ensurePool();
      if (!pool.length) {
        setStatusPill("SOLD OUT", false);
        return;
      }

      const draw = pool.pop();
      currentDraw = draw;

      usedSet.add(String(idx));
      saveUsedCells();
      cellEl.classList.add("used");

      openDrawModal(draw);
    }

    function openDrawModal(draw) {
      drawModalEl.classList.remove("hidden");
      drawModalInfoEl.textContent = "손가락(마우스)으로 박박 긁어봐!";
      scratchDebugTextEl.textContent = "";
      scratchDrawnPoints = 0;
      scratchLastPos = null;

      drawRevealImageEl.src = draw.image || DRAW_MODAL_PAPER_IMAGE;

      prepareScratchCanvas();
    }

    function closeDrawModal(force = false) {
      if (!force && hasScratchProgress()) {
        return;
      }
      drawModalEl.classList.add("hidden");
      clearScratchCanvas();
    }

    function openResultModal(draw) {
      resultModalEl.classList.remove("hidden");
      resultModalTitleEl.textContent = draw.name;
      resultModalImageEl.src = draw.image || "";
      resultModalNoteEl.textContent = draw.isMiss ? "다음 기회에...!" : "축하해!";
      startAutoCloseTimer();
    }

    function closeResultModal() {
      resultModalEl.classList.add("hidden");
      stopAutoCloseTimer();
    }

    function startAutoCloseTimer() {
      stopAutoCloseTimer();
      autoCloseStartAt = Date.now();
      updateAutoCloseText();
      autoCloseTimer = setInterval(() => {
        updateAutoCloseText();
        if (Date.now() - autoCloseStartAt >= AUTO_CLOSE_MS) {
          closeResultModal();
        }
      }, 1000);
    }

    function stopAutoCloseTimer() {
      if (autoCloseTimer) clearInterval(autoCloseTimer);
      autoCloseTimer = null;
      resultAutoCloseTextEl.textContent = "1분 후 자동으로 닫힙니다.";
    }

    function updateAutoCloseText() {
      const left = Math.max(0, AUTO_CLOSE_MS - (Date.now() - autoCloseStartAt));
      const sec = Math.ceil(left / 1000);
      resultAutoCloseTextEl.textContent = `${sec}초 후 자동으로 닫힙니다.`;
    }

    function hasScratchProgress() {
      return scratchDrawnPoints > 60;
    }

    function prepareScratchCanvas() {
      const canvas = drawScratchCanvasEl;
      const ctx = canvas.getContext("2d");
      scratchCtx = ctx;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const coverImg = new Image();
      coverImg.onload = () => {
        ctx.save();
        ctx.globalCompositeOperation = "source-over";
        ctx.drawImage(coverImg, 0, 0, canvas.width, canvas.height);
        ctx.restore();
      };
      coverImg.src = DRAW_MODAL_PAPER_IMAGE;
    }

    function clearScratchCanvas() {
      if (!scratchCtx) return;
      scratchCtx.clearRect(0, 0, drawScratchCanvasEl.width, drawScratchCanvasEl.height);
      scratchCtx = null;
    }

    function getCanvasPoint(event) {
      const rect = drawScratchCanvasEl.getBoundingClientRect();
      const x = ((event.clientX - rect.left) / rect.width) * drawScratchCanvasEl.width;
      const y = ((event.clientY - rect.top) / rect.height) * drawScratchCanvasEl.height;
      return { x, y };
    }

    function drawScratchLine(from, to) {
      if (!scratchCtx) return;
      scratchCtx.save();
      scratchCtx.globalCompositeOperation = "destination-out";
      scratchCtx.lineWidth = 28;
      scratchCtx.lineCap = "round";
      scratchCtx.lineJoin = "round";
      scratchCtx.beginPath();
      scratchCtx.moveTo(from.x, from.y);
      scratchCtx.lineTo(to.x, to.y);
      scratchCtx.stroke();
      scratchCtx.restore();
      scratchDrawnPoints += 1;
    }

    function startScratch(event) {
      event.preventDefault();
      scratchIsDown = true;
      scratchLastPos = getCanvasPoint(event);
    }

    function moveScratch(event) {
      if (!scratchIsDown || !scratchLastPos) return;
      const pos = getCanvasPoint(event);
      drawScratchLine(scratchLastPos, pos);
      scratchLastPos = pos;

      if (scratchDrawnPoints % 20 === 0) {
        scratchDebugTextEl.textContent = "계속 긁는 중...";
      }
    }

    function endScratch() {
      if (!scratchIsDown) return;
      scratchIsDown = false;
      scratchLastPos = null;

      if (hasScratchProgress()) {
        commitSwipeDraw();
      }
    }

    function commitSwipeDraw() {
      if (!currentDraw) return;
      closeDrawModal(true);
      openResultModal(currentDraw);
      currentDraw = null;
    }

    function initFromSettings(settings) {
      drawSettings = settings;
      cols = Number(settings.cols || 15);
      rows = Number(settings.rows || 30);
      includeMiss = Boolean(settings.includeMiss);

      setupColsEl.value = cols;
      setupRowsEl.value = rows;
      includeMissEl.checked = includeMiss;
      setupAdminPasswordEl.value = String(settings.adminPassword || "0000");

      rankRowsEl.innerHTML = "";
      (settings.rankRows || []).forEach((r, idx) => {
        createRankRow(r, idx === 0 && r.name === "꽝");
      });

      renderRemainList();
    }

    function getCurrentSettingsFromUI() {
      const settings = {
        cols: Number(setupColsEl.value || 15),
        rows: Number(setupRowsEl.value || 30),
        includeMiss: Boolean(includeMissEl.checked),
        adminPassword: String(setupAdminPasswordEl.value || "0000"),
        rankRows: readRankRows()
      };
      return settings;
    }

    function startGame() {
      const settings = getCurrentSettingsFromUI();
      saveSettings(settings);

      cols = settings.cols;
      rows = settings.rows;
      includeMiss = settings.includeMiss;
      poolLoaded = false;
      pool = [];

      renderRemainList();
      renderGrid();

      adminUnlocked = getAdminToken() === "1";
      statusLocked = getStatusLocked();

      setAdminUI();
      lockStatusUI(statusLocked);

      showScreen("game");
    }

    function askAdminUnlock() {
      const pw = prompt("관리자 비밀번호를 입력하세요");
      if (pw == null) return;
      const saved = String(getCurrentSettingsFromUI().adminPassword || "0000");
      if (pw === saved) {
        adminUnlocked = !adminUnlocked;
        setAdminToken(adminUnlocked ? "1" : "0");
        setAdminUI();
      } else {
        alert("비밀번호가 틀렸습니다.");
      }
    }

    toggleStatusBtnEl.addEventListener("click", askAdminUnlock);

    openDrawBtnEl.addEventListener("click", () => {
      if (statusLocked && !adminUnlocked) {
        setStatusPill("LOCKED", false);
        return;
      }
      ensurePool();
      if (!pool.length) {
        setStatusPill("SOLD OUT", false);
        return;
      }
      currentDraw = pool.pop();
      openDrawModal(currentDraw);
    });

    addRankBtn.addEventListener("click", () => {
      createRankRow({ name: "", mode: "count", value: 0, image: "" }, false);
      renderRemainList();
    });

    startGameBtn.addEventListener("click", startGame);

    includeMissEl.addEventListener("change", () => {
      if (includeMissEl.checked) {
        const firstRow = rankRowsEl.querySelector(".rank-row");
        if (!firstRow || firstRow.querySelector("input").value.trim() !== "꽝") {
          createRankRow({ name: "꽝", mode: "count", value: 0, image: "/img/miss.png" }, true);
        }
      } else {
        const rows = [...rankRowsEl.querySelectorAll(".rank-row")];
        const first = rows[0];
        if (first && first.querySelector("input").value.trim() === "꽝") {
          first.remove();
        }
      }
      renderRemainList();
    });

    drawCancelBtnEl.addEventListener("click", () => {
      if (hasScratchProgress()) {
        commitSwipeDraw();
      } else {
        closeDrawModal(false);
      }
    });
    drawModalEl.addEventListener("click", (event) => {
      if (event.target === drawModalEl) {
        if (hasScratchProgress()) {
          commitSwipeDraw();
        } else {
          closeDrawModal(false);
        }
      }
    });
    resultCloseBtnEl.addEventListener("click", closeResultModal);
    resultModalEl.addEventListener("click", (event) => {
      if (event.target === resultModalEl) {
        closeResultModal();
      }
    });

    drawScratchCanvasEl.addEventListener("pointerdown", (event) => {
      if (event.button !== undefined && event.button !== 0) return;
      startScratch(event);
    });
    drawScratchCanvasEl.addEventListener("pointermove", moveScratch);
    drawScratchCanvasEl.addEventListener("pointerup", endScratch);
    drawScratchCanvasEl.addEventListener("pointercancel", endScratch);
    drawScratchCanvasEl.addEventListener("mouseleave", endScratch);
    window.addEventListener("pointerup", endScratch);
    window.addEventListener("pointercancel", endScratch);
    window.addEventListener("mouseup", endScratch);

    const saved = loadSavedSettings();
    if (saved) {
      initFromSettings(saved);
    } else {
      loadDefaultRows();
    }
  </script>
</body>
</html>
